<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCK Record Book - Cloud</title>
  
  <link rel="icon" type="image/png" href="logo.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <!-- START: FIX - Added Tailwind dark mode configuration -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {}
      }
    }
  </script>
  <!-- END: FIX -->
  <!-- Pyodide for Excel Generation -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <!-- Chart.js for Graphics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- START: HELP TOUR LIBRARY (Shepherd.js) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
  <!-- END: HELP TOUR LIBRARY -->

  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .new-row, .modal-backdrop { animation: fadeIn 0.5s ease-out; }
    select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    .dark select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    }
    .hidden { display: none; }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
    .toast { animation: toast-in 0.5s ease-out forwards; }
    .toast.fading-out { animation: toast-out 0.5s ease-in forwards; }
    @keyframes slide-up {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slide-down {
        from { transform: translateY(0); opacity: 1; }
        to { transform: translateY(100%); opacity: 0; }
    }
    .undo-bar {
        animation-duration: 0.5s;
        animation-timing-function: ease-out;
    }
    .undo-bar.show { animation-name: slide-up; }
    .undo-bar.hide { animation-name: slide-down; }
    .chart-btn.active, .kpi-range-btn.active {
        background-color: #f97316; /* TCK Orange */
        color: white;
    }
    /* Hide number input spinners */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
      appearance: textfield;
    }
    .journal-card.active {
        border-color: #f97316;
        box-shadow: 0 0 0 2px #f97316;
    }
    .journal-card.merge-destination {
        border-color: #2563eb; /* Blue */
        box-shadow: 0 0 0 2px #2563eb;
        background-color: #eff6ff; /* Blue-50 */
    }
    .dark .journal-card.merge-destination {
        background-color: #1e3a8a; /* Blue-800 */
    }
    .journal-card.disabled-card {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: #f3f4f6; /* Gray-100 */
    }
    .dark .journal-card.disabled-card {
        background-color: #374151; /* Gray-700 */
    }

    /* START: HELP BUTTON STYLES */
    .help-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #f97316; /* TCK Orange */
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        transition: transform 0.2s ease-in-out;
    }
    .help-btn:hover {
        transform: scale(1.1);
        background-color: #ea580c; /* Darker Orange */
    }
    /* END: HELP BUTTON STYLES */

    /* START: SHEPHERD TOUR STYLES */
    .shepherd-element, .shepherd-element *, .shepherd-element ::before, .shepherd-element ::after {
        box-sizing: border-box;
    }
    .shepherd-element {
        background: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        max-width: 350px;
        width: 100%;
        font-family: 'Inter', sans-serif;
        z-index: 9999;
    }
    .dark .shepherd-element {
        background: #1f2937; /* Gray-800 */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
    }
    .shepherd-arrow, .shepherd-arrow::before {
        position: absolute;
        width: 1rem;
        height: 1rem;
        background: #fff;
        transform: rotate(45deg);
    }
    .dark .shepherd-arrow, .dark .shepherd-arrow::before {
        background: #1f2937;
    }
    .shepherd-element[data-popper-placement^="top"] > .shepherd-arrow { bottom: -0.5rem; }
    .shepherd-element[data-popper-placement^="bottom"] > .shepherd-arrow { top: -0.5rem; }
    .shepherd-element[data-popper-placement^="left"] > .shepherd-arrow { right: -0.5rem; }
    .shepherd-element[data-popper-placement^="right"] > .shepherd-arrow { left: -0.5rem; }
    .shepherd-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    .dark .shepherd-header { border-bottom: 1px solid #374151; /* Gray-700 */ }
    .shepherd-title {
        color: #111827;
        font-size: 1rem;
        font-weight: 600;
    }
    .dark .shepherd-title { color: #f3f4f6; /* Gray-100 */ }
    .shepherd-cancel-icon {
        background: transparent;
        border: 0;
        cursor: pointer;
        color: #6b7280;
        transition: color 0.2s ease;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
    }
    .dark .shepherd-cancel-icon { color: #9ca3af; /* Gray-400 */ }
    .dark .shepherd-cancel-icon:hover { color: #f3f4f6; }
    .shepherd-cancel-icon:hover { color: #111827; }
    .shepherd-text {
        padding: 1rem;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #4b5563;
    }
    .dark .shepherd-text { color: #d1d5db; /* Gray-300 */ }
    .shepherd-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 1rem 0.75rem 1rem;
    }
    .shepherd-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .shepherd-button:focus {
        outline: 2px solid transparent;
        outline-offset: 2px;
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.4);
    }
    .shepherd-button.shepherd-button-primary {
        background-color: #f97316;
        color: white;
    }
    .shepherd-button.shepherd-button-primary:hover { background-color: #ea580c; }
    .shepherd-button.shepherd-button-secondary {
        background-color: #e5e7eb;
        color: #374151;
    }
    .shepherd-button.shepherd-button-secondary:hover { background-color: #d1d5db; }
    .dark .shepherd-button.shepherd-button-secondary {
        background-color: #374151; /* Gray-700 */
        color: #f3f4f6; /* Gray-100 */
    }
    .dark .shepherd-button.shepherd-button-secondary:hover { background-color: #4b5563; /* Gray-600 */ }
    .shepherd-button svg { width: 1rem; height: 1rem; }
    /* END: SHEPHERD TOUR STYLES */

    /* Hides the selection column when not on the manage tab */
    #entriesTable.selection-hidden > thead > tr > th:first-child,
    #entriesTable.selection-hidden > tbody > tr > td:first-child {
        display: none;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen font-sans">

  <!-- Login View -->
  <div id="login-view" class="w-full min-h-screen flex items-center justify-center p-4">
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm w-full max-w-md dark:bg-gray-800 dark:border-gray-700">
          <form id="loginForm">
              <div id="email-step" class="p-8 md:p-10">
                  <div class="text-center mb-8">
                      <img src="logo.png" alt="TCK Logo" class="mx-auto h-20 mb-4">
                      <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Sign in</h1>
                      <p class="text-gray-600 dark:text-gray-400 mt-2">to continue to TCK Record Book</p>
                  </div>
                  <div id="email-auth-error" class="text-red-500 text-sm text-center mb-4"></div>
                  <div>
                      <label for="email" class="sr-only">Email</label>
                      <input type="email" id="email" placeholder="Email" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" />
                  </div>
                  <div class="flex items-center justify-end mt-8">
                      <button type="button" id="next-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-md shadow-sm transition-all duration-200">Next</button>
                  </div>
              </div>
              <div id="password-step" class="hidden p-8 md:p-10">
                  <div class="text-center mb-8">
                      <img src="logo.png" alt="TCK Logo" class="mx-auto h-20 mb-4">
                      <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Welcome</h1>
                      <div class="mt-3">
                          <button type="button" id="change-email-btn" class="inline-flex items-center gap-2 border border-gray-300 rounded-full py-1 px-3 text-sm text-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">
                              <span id="user-email-display"></span>
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                          </button>
                      </div>
                  </div>
                  <div id="password-auth-error" class="text-red-500 text-sm text-center mb-4"></div>
                  <div class="relative">
                      <label for="password" class="sr-only">Password</label>
                      <input type="password" id="password" placeholder="Enter your password" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-3 pr-10 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" />
                      <button type="button" id="toggle-password-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <svg id="eye-open-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <svg id="eye-closed-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                        </svg>
                      </button>
                  </div>
                  <div class="flex items-center justify-end mt-8">
                      <button type="submit" id="submit-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-md shadow-sm transition-all duration-200">Sign In</button>
                  </div>
              </div>
          </form>
      </div>
      <button id="login-help-btn" class="help-btn" title="Help">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>
  </div>

  <!-- Main App View -->
  <div id="app-view" class="w-full hidden">
    <header class="sticky top-0 z-50 bg-white shadow-md dark:bg-gray-800/95 dark:backdrop-blur-sm dark:border-b dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-2 sm:px-4 md:px-6 py-3 flex flex-nowrap items-center justify-between gap-x-2 sm:gap-x-4">
            <div class="flex items-center gap-3 flex-shrink-0">
                <img src="logo.png" alt="TCK Logo" class="h-10 sm:h-12 w-auto">
                <h1 class="text-xl font-bold text-gray-800 dark:text-gray-100 hidden sm:block">TCK Record Book</h1>
            </div>
            <nav class="flex-grow flex justify-center">
                <div class="flex space-x-1 sm:space-x-2" aria-label="Tabs">
                    <button id="dashboard-tab-btn" type="button" title="Dashboard" class="tab-btn flex items-center gap-2 whitespace-nowrap py-2 px-3 rounded-md font-medium text-sm bg-orange-500 text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
                        <span class="hidden md:inline">Dashboard</span>
                    </button>
                    <button id="add-entry-tab-btn" type="button" title="Add Entry" class="tab-btn flex items-center gap-2 whitespace-nowrap py-2 px-3 rounded-md font-medium text-sm text-gray-500 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="hidden md:inline">Add Entry</span>
                    </button>
                    <button id="management-tab-btn" type="button" title="Manage Entries" class="tab-btn flex items-center gap-2 whitespace-nowrap py-2 px-3 rounded-md font-medium text-sm text-gray-500 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.875 0h15.75c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H4.125A1.125 1.125 0 003 5.625v12.75c0 .621.504 1.125 1.125 1.125z" /></svg>
                        <span class="hidden md:inline">Manage Entries</span>
                    </button>
                    <button id="data-management-tab-btn" type="button" title="Journals" class="tab-btn flex items-center gap-2 whitespace-nowrap py-2 px-3 rounded-md font-medium text-sm text-gray-500 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                        <span class="hidden md:inline">Journals</span>
                    </button>
                </div>
            </nav>
            <div class="flex items-center flex-shrink-0 gap-2 sm:gap-4">
                <button id="theme-toggle-btn" type="button" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 dark:focus:ring-offset-gray-800" title="Toggle theme">
                    <svg id="theme-icon-light" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    <svg id="theme-icon-system" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                </button>
                <span id="syncStatus" class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1"></span>
                <div class="relative">
                    <button id="user-menu-button" type="button" class="flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-orange-600 p-1 rounded-full hover:bg-orange-50 dark:text-gray-300 dark:hover:bg-gray-700">
                        <span id="user-role-icon" class="flex-shrink-0">
                           <svg id="user-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                           <svg id="admin-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" /></svg>
                        </span>
                        <span id="userEmail" class="hidden md:block"></span>
                        <span id="userRoleBadge" class="hidden text-xs font-bold uppercase px-2 py-1 rounded-full"></span>
                        <svg class="w-4 h-4 hidden sm:block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="user-menu" class="hidden absolute right-0 mt-2 w-56 origin-top-right bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none dark:bg-gray-800 dark:ring-gray-600" role="menu">
                        <div class="py-1" role="none">
                            <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300">
                                <p class="font-medium">Signed in as</p>
                                <p id="user-email-dropdown" class="truncate"></p>
                            </div>
                            <button id="adminMenuBtn" class="hidden w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700" role="menuitem">Admin Panel</button>
                            <button id="signOutBtn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">Sign Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="w-full p-4 md:p-6">
        <div id="tab-content-wrapper" class="max-w-7xl w-full mx-auto">
            <div id="dashboard-content-container">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 id="dashboard-title" class="text-xl font-bold text-gray-800 dark:text-gray-100">Dashboard</h2>
                    <div id="dashboard-range-selector" class="inline-flex rounded-md shadow-sm" role="group">
                         <button type="button" data-range="week" class="kpi-range-btn px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">This Week</button>
                         <button type="button" data-range="month" class="kpi-range-btn px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-orange-500 active dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">This Month</button>
                         <button type="button" data-range="year" class="kpi-range-btn px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-r border-gray-200 hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">This Year</button>
                         <button type="button" data-range="all" class="kpi-range-btn px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">All Time</button>
                    </div>
                </div>
                <div id="dashboard-message" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">Select a journal to see the dashboard.</div>
                <div id="dashboard-main-content">
                    <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow p-5 dark:bg-gray-800">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Income</p>
                            <p id="kpi-income" class="text-3xl font-bold text-gray-800 mt-1 dark:text-gray-100">UGX 0</p>
                            <p id="kpi-income-comp" class="text-xs text-gray-500 dark:text-gray-400 mt-1"> </p>
                        </div>
                        <div class="bg-white rounded-xl shadow p-5 dark:bg-gray-800">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Expense</p>
                            <p id="kpi-expense" class="text-3xl font-bold text-gray-800 mt-1 dark:text-gray-100">UGX 0</p>
                            <p id="kpi-expense-comp" class="text-xs text-gray-500 dark:text-gray-400 mt-1"> </p>
                        </div>
                        <div class="bg-white rounded-xl shadow p-5 dark:bg-gray-800">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Net Balance</p>
                            <p id="kpi-net" class="text-3xl font-bold text-gray-800 mt-1 dark:text-gray-100">UGX 0</p>
                            <p id="kpi-net-comp" class="text-xs text-gray-500 dark:text-gray-400 mt-1"> </p>
                        </div>
                    </div>
                    <div id="charts-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow p-5 h-80 dark:bg-gray-800"><canvas id="incomeBarChart"></canvas></div>
                        <div class="bg-white rounded-xl shadow p-5 h-80 dark:bg-gray-800"><canvas id="expenseBarChart"></canvas></div>
                        <div class="bg-white rounded-xl shadow p-5 h-80 dark:bg-gray-800">
                             <div class="text-center mb-2">
                                <h3 id="chart-title" class="text-md font-semibold text-gray-700 dark:text-gray-300">Breakdown by Source</h3>
                                <div class="flex justify-center items-center gap-4 mt-1">
                                    <div class="inline-flex rounded-md shadow-sm" role="group">
                                        <button type="button" id="chart-type-expense" class="chart-btn px-3 py-1 text-xs font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">Expenses</button>
                                        <button type="button" id="chart-type-income" class="chart-btn px-3 py-1 text-xs font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">Incomes</button>
                                    </div>
                                </div>
                            </div>
                            <div class="relative h-56 w-full"><canvas id="donutChart"></canvas></div>
                        </div>
                        <div class="bg-white rounded-xl shadow p-5 h-80 dark:bg-gray-800"><canvas id="netBalanceAreaChart"></canvas></div>
                    </div>
                </div>
            </div>
            
            <div id="add-entry-content-container" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl shadow-lg p-6 w-full dark:bg-gray-800">
                          <h2 class="text-xl font-bold text-gray-800 mb-4 dark:text-gray-100">Add New Entry</h2>
                          <form id="entryForm" class="grid grid-cols-1 gap-4">
                            <div>
                              <label for="date-day" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                              <div class="mt-1 flex items-center gap-2 relative">
                                <input type="number" id="date-day" placeholder="DD" min="1" max="31" required class="w-1/4 rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 text-center dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                <span class="text-gray-400">/</span>
                                <input type="number" id="date-month" placeholder="MM" min="1" max="12" required class="w-1/4 rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 text-center dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                <span class="text-gray-400">/</span>
                                <input type="number" id="date-year" placeholder="YYYY" min="1900" max="2100" required class="w-2/4 rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 text-center dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                <button type="button" id="date-picker-btn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                  <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </button>
                                <input type="date" id="native-date-picker" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" style="z-index: -1;" />
                              </div>
                            </div>
                            <div>
                              <label for="type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Entry Type</label>
                              <select id="type" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="Income">Income</option>
                                <option value="Expense" selected>Expense</option>
                              </select>
                            </div>
                            <div>
                              <label for="method" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Source / Method</label>
                              <select id="method" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="MTN">MTN</option>
                                <option value="Airtel">Airtel</option>
                                <option value="Bank" selected>Bank</option>
                              </select>
                            </div>
                            <div>
                              <label for="narration" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Narration / Category</label>
                              <input type="text" id="narration" list="narration-suggestions" placeholder="e.g. Salary, Rent, Groceries" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>
                            <div>
                              <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (UGX)</label>
                              <input type="text" id="amount" inputmode="numeric" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>
                            <button type="submit" id="addEntryBtn" class="mt-3 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50">
                              Add Entry
                            </button>
                          </form>
                        </div>
                    </div>
                    <div id="recent-entries-panel" class="lg:col-span-2">
                         <div class="bg-white rounded-2xl shadow-lg p-6 w-full dark:bg-gray-800">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">Recent Entries</h2>
                               
                            </div>
                            <div class="overflow-y-auto" style="max-height: 28rem;">
                                <table id="recentEntriesTable" class="min-w-full text-sm">
                                    <thead class="bg-gray-100 sticky top-0 dark:bg-gray-700">
                                        <tr class="text-left text-gray-600 uppercase tracking-wider dark:text-gray-400">
                                            <th class="py-2 px-4">Date</th>
                                            <th class="py-2 px-4">Narration</th>
                                            <th class="py-2 px-4">Type</th>
                                            <th class="py-2 px-4 text-right">Amount</th>
                                            <th class="py-2 px-4 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-entries-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="management-content-container" class="hidden">
              <div class="w-full bg-white rounded-2xl shadow-lg overflow-hidden dark:bg-gray-800">
                <div class="p-6">
                  <!-- START: TWEAK 3 - Replaced title with dropdown -->
                  <div class="flex justify-between items-center flex-wrap gap-4 mb-4">
                      <div class="flex items-center gap-3">
                          <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">Entries for:</h2>
                          <select id="manage-journal-select" class="rounded-lg border-gray-300 shadow-sm p-2 text-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                      </div>
                      <button id="downloadBtn" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                          Download Excel
                      </button>
                  </div>
                  <!-- END: TWEAK 3 -->
                  <div class="bg-gray-100 rounded-lg p-4 mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-center dark:bg-gray-700/50">
                      <div>
                          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Filtered Income</p>
                          <p id="filtered-income" class="text-lg font-bold text-lime-600 dark:text-lime-500">UGX 0</p>
                      </div>
                      <div>
                          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Filtered Expense</p>
                          <p id="filtered-expense" class="text-lg font-bold text-red-600 dark:text-red-500">UGX 0</p>
                      </div>
                      <div>
                          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Net</p>
                          <p id="filtered-net" class="text-lg font-bold text-blue-800 dark:text-blue-400">UGX 0</p>
                      </div>
                  </div>
                  <div id="manage-filters" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                      <div>
                          <label for="start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                          <input type="date" id="start-date" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:[color-scheme:dark]">
                      </div>
                      <div>
                          <label for="end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date</label>
                          <input type="date" id="end-date" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:[color-scheme:dark]">
                      </div>
                      <div class="col-span-2 md:col-span-1">
                          <label class="block text-sm font-medium text-transparent">Actions</label>
                          <div class="flex gap-2">
                            <button id="filter-by-date-btn" class="w-full mt-1 bg-orange-200 hover:bg-orange-300 text-orange-800 font-bold py-2 px-4 rounded-lg text-sm dark:bg-orange-800/50 dark:hover:bg-orange-800/80 dark:text-orange-200">Filter</button>
                            <button id="clear-date-filter-btn" class="w-full mt-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200">Clear</button>
                          </div>
                      </div>
                  </div>
                  <div class="mb-4">
                      <label for="search-input" class="sr-only">Search Entries</label>
                      <input type="search" id="search-input" placeholder="Search by narration..." class="w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                  </div>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                      <div>
                          <label for="sort-by" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sort by</label>
                          <select id="sort-by" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                              <option value="date_desc">Newest First</option>
                              <option value="date_asc">Oldest First</option>
                              <option value="amount_desc">Amount (High-Low)</option>
                              <option value="amount_asc">Amount (Low-High)</option>
                          </select>
                      </div>
                      <div>
                          <label for="filter-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                          <select id="filter-type" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                              <option value="all">All</option>
                              <option value="Income">Income</option>
                              <option value="Expense">Expense</option>
                          </select>
                      </div>
                      <div>
                          <label for="filter-method" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Method</label>
                          <select id="filter-method" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                              <option value="all">All</option>
                              <option value="MTN">MTN</option>
                              <option value="Airtel">Airtel</option>
                              <option value="Bank">Bank</option>
                          </select>
                      </div>
                       <div>
                          <label class="block text-sm font-medium text-transparent">Reset</label>
                          <button id="reset-filters" class="w-full mt-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200">
                              Reset All Filters
                          </button>
                      </div>
                  </div>
                   <p id="statusMessage" class="text-center text-sm text-gray-600 dark:text-gray-400 mt-1 h-5"></p>
                </div>
                <div id="bulk-delete-wrapper" class="px-6 pb-4 flex items-center gap-4">
                    <button id="bulk-delete-btn" class="hidden bg-red-100 hover:bg-red-200 text-red-700 font-bold py-2 px-4 rounded-lg text-sm dark:bg-red-900/50 dark:hover:bg-red-900/80 dark:text-red-200">Delete Selected (0)</button>
                </div>
                <div class="overflow-x-auto">
                  <table id="entriesTable" class="min-w-full text-sm">
                    <thead class="bg-gray-100 border-b border-gray-200 dark:bg-gray-700 dark:border-gray-600">
                      <tr class="text-left text-gray-600 uppercase tracking-wider dark:text-gray-400">
                        <th class="py-3 px-4 w-12 text-center"><input type="checkbox" id="select-all-checkbox"></th>
                        <th class="py-3 px-4">Date</th>
                        <th class="py-3 px-4">Type</th>
                        <th class="py-3 px-4">Method</th>
                        <th class="py-3 px-4">Narration</th>
                        <th class="py-3 px-4 text-right">Amount</th>
                        <th class="py-3 px-4 text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                  </table>
                </div>
                <div id="pagination-controls" class="p-6 flex justify-center items-center gap-4 text-sm">
                    <button id="prev-page-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">Previous</button>
                    <span id="page-info" class="dark:text-gray-300">Page 1 of 1</span>
                    <button id="next-page-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">Next</button>
                </div>
              </div>
            </div>
            
            <div id="data-management-content-container" class="hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-2xl mx-auto dark:bg-gray-800">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <!-- START: CHANGE #4 - Renamed title -->
                        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">Journals</h2>
                        <!-- END: CHANGE #4 -->
                        <div class="flex items-center gap-2">
                            <button id="mergeJournalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm">
                                Merge Journals
                            </button>
                            <button id="createJournalBtn" class="bg-lime-600 hover:bg-lime-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm">
                                Create New
                            </button>
                        </div>
                    </div>
                    <p id="merge-status-message" class="text-center text-sm text-blue-800 bg-blue-100 p-2 rounded-lg mb-4 hidden dark:bg-blue-900/50 dark:text-blue-200"></p>
                    <div id="journal-cards-container" class="space-y-3">
                    </div>
                </div>
            </div>

            <!-- ADMIN PANEL -->
            <div id="admin-content-container" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl shadow-lg p-6 w-full dark:bg-gray-800">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 dark:text-gray-100">Data Management</h2>
                            <div class="space-y-4">
                                <button id="downloadBackupBtn" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                                    Download Backup (JSON)
                                </button>
                                <button id="importBackupBtn" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                                    Import from Backup
                                </button>
                                <input type="file" id="fileImporter" class="hidden" accept=".json">
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl shadow-lg p-6 w-full dark:bg-gray-800">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 dark:text-gray-100">User Activities</h2>
                            <div id="activity-log-container" class="overflow-y-auto space-y-4" style="max-height: 40rem;">
                                <p class="text-gray-500 dark:text-gray-400 text-center">Loading activity log...</p>
                                <!-- Activity log will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <datalist id="narration-suggestions"></datalist>
    </main>

    <div id="undo-toast-container" class="fixed bottom-4 left-0 right-0 z-[9999] flex justify-center px-4 pointer-events-none">
        <!-- Undo toast will be dynamically injected here -->
    </div>
  </div>

  <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
      <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center dark:bg-gray-800">
          <h3 id="modalTitle" class="text-lg font-bold text-gray-900 mb-2 dark:text-gray-100">Are you sure?</h3>
          <p id="modalMessage" class="text-sm text-gray-600 mb-6 dark:text-gray-300">This action cannot be undone.</p>
          <div class="flex justify-center gap-4">
              <button id="modalCancelBtn" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold transition-colors dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">Cancel</button>
              <button id="modalConfirmBtn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors">Confirm</button>
          </div>
      </div>
  </div>

    <div id="importOptionsModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
      <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center dark:bg-gray-800">
          <h3 class="text-lg font-bold text-gray-900 mb-2 dark:text-gray-100">Import Backup</h3>
          <p class="text-sm text-gray-600 mb-6 dark:text-gray-300">How would you like to import the journals from the selected file?</p>
          <div class="space-y-3">
              <button id="importMergeBtn" class="w-full px-6 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-colors">
                  Merge with Existing Data
                  <span class="block text-xs font-normal opacity-80">Adds new journals without deleting current ones.</span>
              </button>
              <button id="importReplaceBtn" class="w-full px-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors">
                  Replace All Data
                  <span class="block text-xs font-normal opacity-80">Deletes all current data before importing.</span>
              </button>
              <button id="importCancelBtn" class="w-full mt-4 px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold transition-colors dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">Cancel</button>
          </div>
      </div>
  </div>

  <div id="editEntryModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 dark:bg-gray-800">
            <h3 class="text-xl font-bold text-gray-800 mb-4 dark:text-gray-100">Edit Entry</h3>
            <form id="editEntryForm" class="grid grid-cols-1 gap-4">
                <input type="hidden" id="editEntryId">
                <div>
                  <label for="edit-date-day" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                  <div class="mt-1 flex items-center gap-2 relative">
                    <input type="number" id="edit-date-day" placeholder="DD" min="1" max="31" required class="w-1/4 rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 text-center dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                    <span class="text-gray-400">/</span>
                    <input type="number" id="edit-date-month" placeholder="MM" min="1" max="12" required class="w-1/4 rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 text-center dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                    <span class="text-gray-400">/</span>
                    <input type="number" id="edit-date-year" placeholder="YYYY" min="1900" max="2100" required class="w-2/4 rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 text-center dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                    <button type="button" id="edit-date-picker-btn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                      <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </button>
                    <input type="date" id="edit-native-date-picker" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" style="z-index: -1;" />
                  </div>
                </div>
                <div>
                    <label for="editType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Entry Type</label>
                    <select id="editType" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="Income">Income</option>
                        <option value="Expense">Expense</option>
                    </select>
                </div>
                <div>
                    <label for="editMethod" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Source / Method</label>
                    <select id="editMethod" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="MTN">MTN</option>
                        <option value="Airtel">Airtel</option>
                        <option value="Bank">Bank</option>
                    </select>
                </div>
                <div>
                    <label for="editNarration" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Narration / Category</label>
                    <input type="text" id="editNarration" list="narration-suggestions" placeholder="e.g. Salary, Rent, Groceries" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                </div>
                <div>
                    <label for="editAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (UGX)</label>
                    <input type="text" id="editAmount" inputmode="numeric" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                </div>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="editCancelBtn" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold transition-colors dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-semibold transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
  <div id="inputModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
      <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 dark:bg-gray-800">
          <h3 id="inputModalTitle" class="text-lg font-bold text-gray-900 mb-2 dark:text-gray-100">Enter a value</h3>
          <p id="inputModalMessage" class="text-sm text-gray-600 mb-4 dark:text-gray-300">Please provide the required information.</p>
          <form id="inputModalForm">
              <input type="text" id="inputModalField" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
              <div class="flex justify-end gap-4 mt-6">
                  <button id="inputModalCancelBtn" type="button" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold transition-colors dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">Cancel</button>
                  <button id="inputModalConfirmBtn" type="submit" class="px-6 py-2 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-semibold transition-colors">Confirm</button>
              </div>
          </form>
      </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 z-[9999] space-y-2"></div>

  <button id="app-help-btn" class="help-btn" title="Help">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  </button>

  <script type="module">
    // --- SDK & LIBRARY IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, updateDoc, writeBatch, enableIndexedDbPersistence, query, where, addDoc, serverTimestamp, orderBy, limit, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import Shepherd from 'https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.esm.min.js';

    // --- FIREBASE CONFIG & INIT ---
    // NOTE: Replace with your actual Firebase config
    const firebaseConfig = { 
        apiKey: "AIzaSyBP4p26TLOqL9muN5JndpUZolaunzQgKC0", 
        authDomain: "ie-entry.firebaseapp.com", 
        projectId: "ie-entry", 
        storageBucket: "ie-entry.appspot.com", 
        messagingSenderId: "864058205761", 
        appId: "1:864058205761:web:a70f7e3e20f0df3a8708c0", 
        measurementId: "G-327XF816YG" 
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    try { 
        enableIndexedDbPersistence(db).catch((err) => console.warn("Offline persistence failed.", err)); 
    } catch (e) { 
        console.error("Error enabling offline persistence: ", e); 
    }

    // --- DOM ELEMENT REFERENCES ---
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const themeIcons = { light: document.getElementById('theme-icon-light'), dark: document.getElementById('theme-icon-dark'), system: document.getElementById('theme-icon-system') };
    const adminMenuBtn = document.getElementById('adminMenuBtn');
    const loginHelpBtn = document.getElementById('login-help-btn');
    const appHelpBtn = document.getElementById('app-help-btn');
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const loginForm = document.getElementById('loginForm');
    const emailStep = document.getElementById('email-step');
    const passwordStep = document.getElementById('password-step');
    const nextBtn = document.getElementById('next-btn');
    const changeEmailBtn = document.getElementById('change-email-btn');
    const submitBtn = document.getElementById('submit-btn');
    const userEmailDisplay = document.getElementById('user-email-display');
    const emailAuthError = document.getElementById('email-auth-error');
    const passwordAuthError = document.getElementById('password-auth-error');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const togglePasswordBtn = document.getElementById('toggle-password-btn');
    const eyeOpenIcon = document.getElementById('eye-open-icon');
    const eyeClosedIcon = document.getElementById('eye-closed-icon');
    const signOutBtn = document.getElementById('signOutBtn');
    const userEmailSpan = document.getElementById('userEmail');
    const userRoleBadge = document.getElementById('userRoleBadge');
    const userIcon = document.getElementById('user-icon');
    const adminIcon = document.getElementById('admin-icon');
    const userEmailDropdown = document.getElementById('user-email-dropdown');
    const userMenuButton = document.getElementById('user-menu-button');
    const userMenu = document.getElementById('user-menu');
    const syncStatus = document.getElementById('syncStatus');
    const entryForm = document.getElementById('entryForm');
    const tableBody = document.getElementById('tableBody');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadBackupBtn = document.getElementById('downloadBackupBtn');
    const importBackupBtn = document.getElementById('importBackupBtn');
    const fileImporter = document.getElementById('fileImporter');
    const statusMessage = document.getElementById('statusMessage');
    const journalCardsContainer = document.getElementById('journal-cards-container');
    const createJournalBtn = document.getElementById('createJournalBtn');
    const importOptionsModal = document.getElementById('importOptionsModal');
    const importMergeBtn = document.getElementById('importMergeBtn');
    const importReplaceBtn = document.getElementById('importReplaceBtn');
    const importCancelBtn = document.getElementById('importCancelBtn');
    const mergeJournalBtn = document.getElementById('mergeJournalBtn');
    const mergeStatusMessage = document.getElementById('merge-status-message');
    const manageJournalSelect = document.getElementById('manage-journal-select');
    const addEntryBtn = document.getElementById('addEntryBtn');
    const dateDayInput = document.getElementById('date-day');
    const dateMonthInput = document.getElementById('date-month');
    const dateYearInput = document.getElementById('date-year');
    const datePickerBtn = document.getElementById('date-picker-btn');
    const nativeDatePicker = document.getElementById('native-date-picker');
    const typeSelect = document.getElementById('type');
    const methodSelect = document.getElementById('method');
    const narrationInput = document.getElementById('narration');
    const amountInput = document.getElementById('amount');
    const narrationSuggestions = document.getElementById('narration-suggestions');
    const searchInput = document.getElementById('search-input');
    const sortBySelect = document.getElementById('sort-by');
    const filterTypeSelect = document.getElementById('filter-type');
    const filterMethodSelect = document.getElementById('filter-method');
    const resetFiltersBtn = document.getElementById('reset-filters');
    const confirmationModal = document.getElementById('confirmationModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const inputModal = document.getElementById('inputModal');
    const inputModalForm = document.getElementById('inputModalForm');
    const inputModalTitle = document.getElementById('inputModalTitle');
    const inputModalMessage = document.getElementById('inputModalMessage');
    const inputModalField = document.getElementById('inputModalField');
    const inputModalCancelBtn = document.getElementById('inputModalCancelBtn');
    const editEntryModal = document.getElementById('editEntryModal');
    const editEntryForm = document.getElementById('editEntryForm');
    const editCancelBtn = document.getElementById('editCancelBtn');
    const editDateDayInput = document.getElementById('edit-date-day');
    const editDateMonthInput = document.getElementById('edit-date-month');
    const editDateYearInput = document.getElementById('edit-date-year');
    const editDatePickerBtn = document.getElementById('edit-date-picker-btn');
    const editNativeDatePicker = document.getElementById('edit-native-date-picker');
    const editAmountInput = document.getElementById('editAmount');
    const recentEntriesBody = document.getElementById('recent-entries-body');
    const undoToastContainer = document.getElementById('undo-toast-container');
    const dashboardMainContent = document.getElementById('dashboard-main-content');
    const dashboardMessage = document.getElementById('dashboard-message');
    const dashboardTitle = document.getElementById('dashboard-title');
    const kpiIncomeEl = document.getElementById('kpi-income');
    const kpiIncomeCompEl = document.getElementById('kpi-income-comp');
    const kpiExpenseEl = document.getElementById('kpi-expense');
    const kpiExpenseCompEl = document.getElementById('kpi-expense-comp');
    const kpiNetEl = document.getElementById('kpi-net');
    const kpiNetCompEl = document.getElementById('kpi-net-comp');
    const kpiRangeBtns = document.querySelectorAll('.kpi-range-btn');
    const donutChartCanvas = document.getElementById('donutChart');
    const incomeBarChartCanvas = document.getElementById('incomeBarChart');
    const expenseBarChartCanvas = document.getElementById('expenseBarChart');
    const netBalanceAreaChartCanvas = document.getElementById('netBalanceAreaChart');
    const chartTitle = document.getElementById('chart-title');
    const chartTypeBtns = { expense: document.getElementById('chart-type-expense'), income: document.getElementById('chart-type-income'), };
    let donutChartInstance, incomeBarChartInstance, expenseBarChartInstance, netBalanceAreaChartInstance;
    const filteredIncomeEl = document.getElementById('filtered-income');
    const filteredExpenseEl = document.getElementById('filtered-expense');
    const filteredNetEl = document.getElementById('filtered-net');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const filterByDateBtn = document.getElementById('filter-by-date-btn');
    const clearDateFilterBtn = document.getElementById('clear-date-filter-btn');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    const pageInfo = document.getElementById('page-info');
    const tabButtons = { dashboard: document.getElementById('dashboard-tab-btn'), add: document.getElementById('add-entry-tab-btn'), manage: document.getElementById('management-tab-btn'), data: document.getElementById('data-management-tab-btn') };
    const tabContents = { dashboard: document.getElementById('dashboard-content-container'), add: document.getElementById('add-entry-content-container'), manage: document.getElementById('management-content-container'), data: document.getElementById('data-management-content-container'), admin: document.getElementById('admin-content-container') };
    const activityLogContainer = document.getElementById('activity-log-container');


    // --- APP STATE ---
    let appData = {}, currentUser = null, currentUserProfile = null, unsubscribeFromFirestore = null, confirmCallback = null, importedDataCache = null, lastActiveSingleJournalId = null;
    let isMergeModeActive = false, mergeDestinationId = null;
    let viewOptions = { currentJournalView: 'all', sortBy: 'date_desc', filterByType: 'all', filterByMethod: 'all', searchTerm: '', startDate: null, endDate: null, currentPage: 1, itemsPerPage: 50, chartDataType: 'expense', dashboardDateRange: 'month' };
    let selectedEntryIds = new Set();
    let syncTimeout, inactivityTimer, tour, inputConfirmCallback = null, undoCache = null, undoTimeout, currentUndoToast = null;
    
    // --- THEME MANAGEMENT ---
    const applyTheme = () => {
        const theme = localStorage.getItem('theme') || 'system';
        
        let isDark;
        if (theme === 'light') {
            isDark = false;
        } else if (theme === 'dark') {
            isDark = true;
        } else {
            isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        }

        document.documentElement.classList.toggle('dark', isDark);

        Object.values(themeIcons).forEach(icon => icon.classList.add('hidden'));
        themeIcons[theme].classList.remove('hidden');

        if (donutChartInstance || incomeBarChartInstance || expenseBarChartInstance || netBalanceAreaChartInstance) {
            if (!tabContents.dashboard.classList.contains('hidden')) {
                renderDashboard();
            }
        }
    };

    const cycleTheme = () => {
        const currentTheme = localStorage.getItem('theme') || 'system';
        const nextTheme = { system: 'light', light: 'dark', dark: 'system' }[currentTheme];
        localStorage.setItem('theme', nextTheme);
        applyTheme();
    };

    themeToggleBtn.addEventListener('click', cycleTheme);
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);


    // --- INACTIVITY & NOTIFICATIONS ---
    const activityEvents = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
    function showToast(message, type = 'success', options = {}) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const colors = { success: 'bg-lime-600', error: 'bg-red-600', info: 'bg-blue-800' };
        toast.className = `toast text-white py-2 px-4 rounded-lg shadow-xl ${colors[type] || colors.info} flex items-center justify-between gap-4`;

        const messageEl = document.createElement('span');
        messageEl.textContent = message;
        toast.appendChild(messageEl);

        if (options.actionText && options.action) {
            const actionBtn = document.createElement('button');
            actionBtn.className = 'bg-white/20 hover:bg-white/40 px-3 py-1 rounded text-xs font-semibold transition-colors';
            actionBtn.textContent = options.actionText;
            actionBtn.onclick = (e) => {
                e.stopPropagation();
                options.action();
                toast.remove();
            };
            toast.appendChild(actionBtn);
        }
        
        container.appendChild(toast);
        
        const timeout = setTimeout(() => {
            if (toast) {
                toast.classList.add('fading-out');
                toast.addEventListener('animationend', () => toast.remove());
            }
        }, options.duration || 7000);

        toast.addEventListener('click', () => {
             toast.classList.add('fading-out');
             toast.addEventListener('animationend', () => {
                toast.remove();
                clearTimeout(timeout);
             });
        });
    }
    function logoutDueToInactivity() { if (auth.currentUser) { signOut(auth); showToast("Logged out due to inactivity", "info"); } }
    function resetInactivityTimer() { clearTimeout(inactivityTimer); inactivityTimer = setTimeout(logoutDueToInactivity, 30 * 60 * 1000); }
    function setupInactivityListeners() { activityEvents.forEach(event => window.addEventListener(event, resetInactivityTimer, true)); resetInactivityTimer(); }
    function removeInactivityListeners() { clearTimeout(inactivityTimer); activityEvents.forEach(event => window.removeEventListener(event, resetInactivityTimer, true)); }
    
    // --- UTILITIES & PYODIDE ---
    function getFormattedDate(date, format = 'dd/mm/yyyy') { if (!date) return ''; const d = new Date(date); const userTimezoneOffset = d.getTimezoneOffset() * 60000; const adjustedDate = new Date(d.getTime() + userTimezoneOffset); const yyyy = adjustedDate.getFullYear(); const mm = String(adjustedDate.getMonth() + 1).padStart(2, '0'); const dd = String(adjustedDate.getDate()).padStart(2, '0'); if (format === 'yyyy-mm-dd') { return `${yyyy}-${mm}-${dd}`; } return `${dd}/${mm}/${yyyy}`; }
    function getIntervalKey(date, interval) { const year = date.getFullYear(); const month = date.getMonth(); if (interval === 'quarter') { const quarter = Math.floor(month / 3) + 1; return `${year}-Q${quarter}`; } if (interval === 'month') { return `${year}-${String(month + 1).padStart(2, '0')}`; } return date.toLocaleDateString('en-CA'); }
    function formatAmountForDashboard(amount) { if (amount == null) return 'UGX 0'; const sign = amount < 0 ? "-" : ""; const absAmount = Math.abs(amount); let formattedValue; if (absAmount >= 1000000) { const millions = absAmount / 1000000; formattedValue = (Math.round(millions * 100) / 100).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + 'M'; } else { formattedValue = absAmount.toLocaleString(); } return `${sign}UGX ${formattedValue}`; }
    let pyodideReadyPromise;
    async function loadPy() { if (!pyodideReadyPromise) { statusMessage.textContent = 'Initializing Excel exporter...'; pyodideReadyPromise = loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/" }).then(async (pyodide) => { statusMessage.textContent = 'Loading libraries...'; await pyodide.loadPackage(['micropip']); const micropip = pyodide.pyimport("micropip"); await micropip.install('openpyxl==3.1.2'); statusMessage.textContent = ''; return pyodide; }); } return pyodideReadyPromise; }
    
    // --- AUTHENTICATION & ROLE MANAGEMENT ---
    onAuthStateChanged(auth, async (user) => {
        const isLoggedIn = !!user;
        appView.classList.toggle('hidden', !isLoggedIn);
        loginView.classList.toggle('hidden', isLoggedIn);
        appHelpBtn.classList.toggle('hidden', !isLoggedIn);
        loginHelpBtn.classList.toggle('hidden', isLoggedIn);

        if (isLoggedIn) {
            currentUser = user;
            await loadUserProfile(user.uid); 
            
            if (!currentUserProfile) return;

            document.body.className = 'bg-gray-50 dark:bg-gray-900 min-h-screen font-sans';
            userEmailSpan.textContent = user.email;
            userEmailDropdown.textContent = user.email;
            updateRoleUI();
            
            loadDataFromFirestore();
            loadPy();
            setupInactivityListeners();
        } else {
            currentUser = null;
            currentUserProfile = null;
            if (unsubscribeFromFirestore) unsubscribeFromFirestore();
            document.body.className = 'bg-gray-100 dark:bg-gray-900 min-h-screen font-sans';
            userEmailSpan.textContent = '';
            syncStatus.innerHTML = '';
            appData = {};
            updateUI();
            removeInactivityListeners();
        }
        applyTheme();
    });

    async function loadUserProfile(uid) {
        try {
            const userDocRef = doc(db, "users", uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const profile = userDocSnap.data();
                if (!profile.organizationId || !profile.role) {
                    showToast("User profile is incomplete. Contact admin. Logging out.", "error");
                    signOut(auth);
                    currentUserProfile = null;
                    return; 
                }
                currentUserProfile = profile;
                await auth.currentUser.getIdToken(true);
            } else {
                showToast("User profile not found in database. Logging out.", "error");
                signOut(auth);
                currentUserProfile = null;
            }
        } catch(error) {
            console.error("Error loading user profile:", error);
            showToast("Could not verify user profile. Check connection and log in again.", "error");
            signOut(auth);
            currentUserProfile = null;
        }
    }
    
    function updateRoleUI() {
        if (!currentUserProfile) return;
        const isAdmin = currentUserProfile.role === 'admin';
        
        adminMenuBtn.classList.toggle('hidden', !isAdmin);
        userRoleBadge.classList.toggle('hidden', !isAdmin);
        if(isAdmin) {
          userRoleBadge.textContent = 'Admin';
          userRoleBadge.className = 'text-xs font-bold uppercase px-2 py-1 rounded-full bg-orange-500 text-white';
        }
        
        userIcon.classList.toggle('hidden', isAdmin);
        adminIcon.classList.toggle('hidden', !isAdmin);

        [mergeJournalBtn, importBackupBtn].forEach(btn => {
            btn.disabled = !isAdmin;
            btn.title = isAdmin ? '' : 'This feature is for admins only.';
            btn.classList.toggle('hidden', !isAdmin); 
        });
    }

    const goToPasswordStep = () => { if (!emailInput.value) { emailAuthError.textContent = 'Please enter your email.'; return; } emailAuthError.textContent = ''; passwordAuthError.textContent = ''; userEmailDisplay.textContent = emailInput.value; emailStep.classList.add('hidden'); passwordStep.classList.remove('hidden'); passwordInput.focus(); };
    nextBtn.addEventListener('click', () => goToPasswordStep());
    changeEmailBtn.addEventListener('click', () => { passwordStep.classList.add('hidden'); emailStep.classList.remove('hidden'); emailInput.focus(); });
    loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = emailInput.value; const password = passwordInput.value; signInWithEmailAndPassword(auth, email, password).catch(error => passwordAuthError.textContent = "Invalid credentials. Please try again."); });
    signOutBtn.addEventListener('click', () => { signOut(auth).then(() => { window.location.reload(); }).catch(error => showToast(error.message, 'error')); });
    emailInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            goToPasswordStep();
        }
    });
    togglePasswordBtn.addEventListener('click', () => {
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeOpenIcon.classList.add('hidden');
            eyeClosedIcon.classList.remove('hidden');
        } else {
            passwordInput.type = 'password';
            eyeOpenIcon.classList.remove('hidden');
            eyeClosedIcon.classList.add('hidden');
        }
    });

    // --- ACTIVITY LOGGING ---
    async function logActivity(action, details = {}) {
        if (!currentUserProfile || !currentUserProfile.organizationId) return;

        try {
            const activityColRef = collection(db, "activity_logs");
            await addDoc(activityColRef, {
                organizationId: currentUserProfile.organizationId,
                userId: currentUser.uid,
                userEmail: currentUser.email,
                action: action,
                details: details,
                timestamp: serverTimestamp()
            });
        } catch (error) {
            console.error("Error logging activity: ", error);
        }
    }

    // --- DATA HANDLING (ORGANIZATION-CENTRIC) ---
    function loadDataFromFirestore() {
        if (!currentUserProfile || !currentUserProfile.organizationId) {
             showToast("Organization not assigned. Cannot load data.", "error");
             return;
        }
        const orgDocRef = doc(db, "organizations", currentUserProfile.organizationId);
        unsubscribeFromFirestore = onSnapshot(orgDocRef, (docSnap) => {
            if (docSnap.exists()) {
                appData = docSnap.data();
                const journalIds = Object.keys(appData.journals || {});
                let initialView = viewOptions.currentJournalView; 
                if (!journalIds.includes(initialView) && initialView !== 'all') {
                  initialView = 'all'; 
                }
                viewOptions.currentJournalView = initialView;
                lastActiveSingleJournalId = (initialView !== 'all') ? initialView : (lastActiveSingleJournalId || journalIds[0] || null);
            } else {
                showToast("Organization data not found. Creating new record.", "info");
                initializeNewOrgState();
                saveDataToFirestore();
            }
            updateUI(); 
        }, (error) => {
            console.error("Firestore snapshot error: ", error);
            showToast("Error connecting to cloud data.", 'error');
        });
    }

    function initializeNewOrgState() {
        const firstJournalId = `journal_${Date.now()}`;
        appData = {
            journals: {
                [firstJournalId]: { name: "Main Journal", entries: [], lastModified: new Date().toISOString() }
            },
            activeJournalId: firstJournalId
        };
        logActivity('initialize_organization');
    }

    async function saveDataToFirestore(updateTimestamp = false) {
        if (!currentUserProfile || !currentUserProfile.organizationId) {
            console.error("Save aborted: No user profile or organization ID.");
            return;
        }

        if(updateTimestamp && appData.activeJournalId && appData.activeJournalId !== 'all' && appData.journals[appData.activeJournalId]) {
            appData.journals[appData.activeJournalId].lastModified = new Date().toISOString();
        }

        clearTimeout(syncTimeout);
        syncStatus.innerHTML = `<svg class="animate-spin h-4 w-4 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span class="dark:text-gray-400">Saving...</span>`;
        
        const orgDocRef = doc(db, "organizations", currentUserProfile.organizationId);
        
        return setDoc(orgDocRef, appData, { merge: true })
            .then(() => {
                syncStatus.innerHTML = `<span class="text-green-600"> Synced</span>`;
            })
            .catch(error => {
                syncStatus.innerHTML = `<span class="text-red-600"> Sync failed</span>`;
                showToast('Save Failed! Check permissions or connection.', 'error');
                console.error("Error saving data to Firestore:", error);
            })
            .finally(() => {
                syncTimeout = setTimeout(() => syncStatus.innerHTML = '', 3000);
            });
    }
    
    // --- UI RENDERING & LOGIC ---
    function updateUI() { 
        const hasJournals = appData.journals && Object.keys(appData.journals).length > 0;
        const isLoggedIn = !!currentUser; 

        if (!hasJournals) {
            tableBody.innerHTML = `<tr id="placeholderRow"><td colspan="7" class="text-center py-10 text-gray-500 dark:text-gray-400">${isLoggedIn ? 'Create a journal to get started.' : 'Sign in to manage your journals.'}</td></tr>`;
            [addEntryBtn, downloadBtn, downloadBackupBtn, searchInput].forEach(el => el.disabled = true); 
            createJournalBtn.disabled = !isLoggedIn;
            
            const isAdmin = currentUserProfile?.role === 'admin';
            mergeJournalBtn.disabled = true;
            importBackupBtn.disabled = !isAdmin;
            
            journalCardsContainer.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400 text-center">No journals to display.</p>`;
            dashboardMainContent.classList.add('hidden'); 
            dashboardMessage.classList.remove('hidden');
            renderTable();
            return; 
        } 
        dashboardMainContent.classList.remove('hidden'); 
        dashboardMessage.classList.add('hidden');
        [createJournalBtn, downloadBackupBtn, searchInput].forEach(el => el.disabled = false);
        
        const isAdmin = currentUserProfile?.role === 'admin';
        mergeJournalBtn.disabled = Object.keys(appData.journals).length < 2 || !isAdmin;
        importBackupBtn.disabled = !isAdmin;
        
        populateNarrationSuggestions();
        renderJournalCards(); 
        setActiveJournalView(viewOptions.currentJournalView); 
    }

    function renderJournalCards() { 
        journalCardsContainer.innerHTML = ''; 
        const journals = appData.journals || {}; 
        const sortedIds = Object.keys(journals).sort((a, b) => journals[a].name.localeCompare(journals[b].name)); 
        
        const isManageTabActive = !tabContents.manage.classList.contains('hidden');
        if (isManageTabActive) {
            const allCard = document.createElement('div');
            allCard.className = `journal-card p-4 border rounded-lg cursor-pointer transition-all ${viewOptions.currentJournalView === 'all' ? 'active' : 'border-gray-200 hover:bg-gray-50 dark:border-gray-700 dark:hover:bg-gray-700/50'}`;
            allCard.dataset.id = 'all'; 
            const totalEntries = Object.values(journals).reduce((sum, j) => sum + (j.entries?.length || 0), 0); 
            allCard.innerHTML = `<div class="flex justify-between items-center"> <div> <h3 class="font-bold text-gray-800 dark:text-gray-100">All Journals</h3> <p class="text-xs text-gray-500 dark:text-gray-400">${sortedIds.length} journals, ${totalEntries} entries</p> </div> ${!isMergeModeActive ? `<button class="select-journal-btn bg-gray-200 text-gray-800 text-xs font-bold py-1 px-3 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500" data-id="all">Select</button>` : ''} </div>`;
            if(isMergeModeActive) allCard.classList.add('disabled-card'); 
            journalCardsContainer.appendChild(allCard); 
        }
        
        const isAdmin = currentUserProfile?.role === 'admin';
        
        sortedIds.forEach(id => { 
            const journal = journals[id]; 
            const card = document.createElement('div'); 
            card.className = `journal-card p-4 border rounded-lg cursor-pointer transition-all`; 
            card.dataset.id = id; 
            if (viewOptions.currentJournalView === id && !isMergeModeActive) { card.classList.add('active'); } else { card.classList.add('border-gray-200', 'hover:bg-gray-50', 'dark:border-gray-700', 'dark:hover:bg-gray-700/50'); }
            
            let cardActionsHTML = '';
            if (isMergeModeActive) {
                if(!isAdmin) {
                    card.classList.add('disabled-card');
                } else {
                    let buttonHTML = '';
                    if (!mergeDestinationId) { buttonHTML = `<button class="select-merge-btn bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-blue-700" data-id="${id}">Select as Destination</button>`; } else { if (id === mergeDestinationId) { card.classList.add('merge-destination'); buttonHTML = `<span class="text-xs font-bold text-blue-800 dark:text-blue-300">DESTINATION</span>`; } else { if (canJournalsBeMerged(id, mergeDestinationId)) { buttonHTML = `<button class="select-merge-btn bg-lime-600 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-lime-700" data-id="${id}">Merge From Here</button>`; } else { card.classList.add('disabled-card'); buttonHTML = `<span class="text-xs font-bold text-red-700 dark:text-red-400">Has different years</span>`; } } }
                    cardActionsHTML = `<div class="flex items-center gap-2">${buttonHTML}</div>`;
                }
            } else {
                 let actionButtons = `<button class="rename-journal-btn text-xs font-semibold text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" data-id="${id}">Rename</button>`;
                if (isAdmin) {
                    actionButtons += ` <button class="delete-journal-btn text-xs font-semibold text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" data-id="${id}">Delete</button>`;
                }
                cardActionsHTML = `<div class="flex items-center gap-2"> ${actionButtons} <button class="select-journal-btn bg-gray-200 text-gray-800 text-xs font-bold py-1 px-3 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500" data-id="${id}">Select</button> </div>`;
            }
            card.innerHTML = `<div class="flex justify-between items-center"> <div> <h3 class="font-bold text-gray-800 truncate dark:text-gray-100">${journal.name}</h3> <p class="text-xs text-gray-500 dark:text-gray-400">${journal.entries?.length || 0} entries</p> </div> ${cardActionsHTML} </div>`;
            journalCardsContainer.appendChild(card);
        });
    }

    function renderManageJournalSelector() {
        if (!manageJournalSelect) return; 
        const wasFocused = document.activeElement === manageJournalSelect;
        const journals = appData.journals || {};
        const hasJournals = Object.keys(journals).length > 0;

        manageJournalSelect.disabled = !hasJournals;

        let optionsHTML = '<option value="all">All Journals</option>';
        if (hasJournals) {
            const sortedIds = Object.keys(journals).sort((a, b) => journals[a].name.localeCompare(journals[b].name));
            optionsHTML += sortedIds.map(id => {
                const journal = journals[id];
                const isSelected = id === viewOptions.currentJournalView ? 'selected' : '';
                return `<option value="${id}" ${isSelected}>${journal.name}</option>`;
            }).join('');
        }
        manageJournalSelect.innerHTML = optionsHTML;
        
        manageJournalSelect.value = viewOptions.currentJournalView;
        
        if (wasFocused) manageJournalSelect.focus();
    }

    function setActiveJournalView(journalId, isUserAction = false) {
        viewOptions.currentJournalView = journalId;

        if (isUserAction) {
            const newActiveJournalId = journalId === 'all' ? null : journalId;
            if (appData.activeJournalId !== newActiveJournalId) {
                appData.activeJournalId = newActiveJournalId;
                saveDataToFirestore();
            }
        }

        let title = "Dashboard"; 
        if (journalId === 'all') { 
            title = 'All Journals';
            entryForm.classList.add('opacity-50', 'pointer-events-none');
            addEntryBtn.disabled = true;
        } else {
            lastActiveSingleJournalId = journalId; 
            title = appData.journals[journalId]?.name || "Dashboard";
            entryForm.classList.remove('opacity-50', 'pointer-events-none');
            tabButtons.add.disabled = false; 
            addEntryBtn.disabled = false;
        } 
        
        if (!dateDayInput.value || !dateMonthInput.value || !dateYearInput.value) {
            const today = new Date();
            dateDayInput.value = String(today.getDate()).padStart(2, '0');
            dateMonthInput.value = String(today.getMonth() + 1).padStart(2, '0');
            dateYearInput.value = today.getFullYear();
        }
        
        resetAllFilters();
    }

    function getFilteredEntries() { const journalView = viewOptions.currentJournalView; let entriesToFilter = []; if (journalView === 'all') { entriesToFilter = Object.values(appData.journals || {}).flatMap(j => j.entries || []); } else { const activeJournal = appData.journals?.[journalView]; if (activeJournal && activeJournal.entries) { entriesToFilter = activeJournal.entries; } } const searchTerm = viewOptions.searchTerm.toLowerCase(); return entriesToFilter.filter(e => { if (!e || !e.date) return false; const entryDate = new Date(e.date); const startDate = viewOptions.startDate ? new Date(viewOptions.startDate) : null; const endDate = viewOptions.endDate ? new Date(viewOptions.endDate) : null; if (startDate && entryDate < startDate) return false; if (endDate && entryDate > endDate) return false; return (viewOptions.filterByType === 'all' || e.type === viewOptions.filterByType) && (viewOptions.filterByMethod === 'all' || e.method === viewOptions.filterByMethod) && (!searchTerm || e.narration.toLowerCase().includes(searchTerm)); }); }
    
    function renderRecentEntriesPreview() { 
      const activeJournalId = viewOptions.currentJournalView;
      const activeJournal = appData.journals[activeJournalId]; 
      if (viewOptions.currentJournalView === 'all' || !activeJournal || !activeJournal.entries || activeJournal.entries.length === 0) { 
        recentEntriesBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500 dark:text-gray-400">${viewOptions.currentJournalView === 'all' ? 'Select a journal to add entries.' : 'No recent entries to show.'}</td></tr>`; return; 
      } 
      const recentEntries = [...activeJournal.entries].sort((a, b) => b.id.localeCompare(a.id)).slice(0, 30); recentEntriesBody.innerHTML = recentEntries.map(entry => { const typeClass = entry.type === 'Income' ? 'bg-lime-100 text-lime-800 dark:bg-lime-900/50 dark:text-lime-200' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-200'; return `<tr class="new-row dark:text-gray-300"> <td class="py-2 px-4 whitespace-nowrap">${getFormattedDate(entry.date)}</td> <td class="py-2 px-4 break-words">${entry.narration}</td> <td class="py-2 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">${entry.type}</span></td> <td class="py-2 px-4 text-right font-mono">${(entry.amount || 0).toLocaleString()}</td> <td class="py-2 px-4 text-center whitespace-nowrap"> <button data-id="${entry.id}" class="edit-btn text-orange-500 hover:text-orange-700 dark:text-orange-400 dark:hover:text-orange-300 font-semibold transition-colors text-xs mr-2">Edit</button> <button data-id="${entry.id}" class="delete-btn text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-semibold transition-colors text-xs">Delete</button> </td> </tr>`; }).join(''); }
    
    function updateFilteredSummary(filteredEntries) { const income = filteredEntries.filter(e => e.type === 'Income').reduce((sum, e) => sum + e.amount, 0); const expense = filteredEntries.filter(e => e.type === 'Expense').reduce((sum, e) => sum + e.amount, 0); const net = income - expense; filteredIncomeEl.textContent = `UGX ${income.toLocaleString()}`; filteredExpenseEl.textContent = `UGX ${expense.toLocaleString()}`; filteredNetEl.textContent = `UGX ${net.toLocaleString()}`; filteredNetEl.className = `text-lg font-bold ${net >= 0 ? 'text-blue-800 dark:text-blue-400' : 'text-red-600 dark:text-red-500'}`; }
    
    function renderTable() { 
        renderManageJournalSelector(); 
        renderDashboard(); 
        renderRecentEntriesPreview(); 
        const allFilteredEntries = getFilteredEntries(); 
        updateFilteredSummary(allFilteredEntries); 
        let sortedEntries = [...allFilteredEntries]; 
        if (viewOptions.sortBy === 'amount_asc') sortedEntries.sort((a, b) => a.amount - b.amount); 
        else if (viewOptions.sortBy === 'amount_desc') sortedEntries.sort((a, b) => b.amount - a.amount); 
        else { sortedEntries.sort((a, b) => new Date(a.date) - new Date(b.date)); if(viewOptions.sortBy === 'date_desc') sortedEntries.reverse(); } 
        const totalPages = Math.ceil(sortedEntries.length / viewOptions.itemsPerPage); 
        viewOptions.currentPage = Math.max(1, Math.min(viewOptions.currentPage, totalPages || 1)); 
        const startIndex = (viewOptions.currentPage - 1) * viewOptions.itemsPerPage; 
        const endIndex = startIndex + viewOptions.itemsPerPage; 
        const entriesToRender = sortedEntries.slice(startIndex, endIndex); 
        tableBody.innerHTML = ''; 
        downloadBtn.disabled = allFilteredEntries.length === 0; 
        if (allFilteredEntries.length === 0) { const hasAnyJournals = Object.keys(appData.journals || {}).length > 0; const message = hasAnyJournals ? "No entries match your current filters." : "No entries in this journal."; tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500 dark:text-gray-400">${message}</td></tr>`; } 
        else { entriesToRender.forEach(entry => tableBody.appendChild(createRowElement(entry))); } 
        updatePaginationControls(sortedEntries.length, totalPages); 
        updateBulkDeleteButton(); 
        selectAllCheckbox.checked = false; 
    }
    
    function createRowElement(entry) { const tr = document.createElement('tr'); tr.className = 'new-row dark:text-gray-300'; tr.dataset.id = entry.id; const isChecked = selectedEntryIds.has(entry.id); tr.innerHTML = ` <td class="py-3 px-4 w-12 text-center"><input type="checkbox" data-id="${entry.id}" class="row-checkbox" ${isChecked ? 'checked' : ''}></td> <td class="py-3 px-4 whitespace-nowrap">${getFormattedDate(entry.date)}</td> <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${entry.type === 'Income' ? 'bg-lime-100 text-lime-800 dark:bg-lime-900/50 dark:text-lime-200' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-200'}">${entry.type}</span></td> <td class="py-3 px-4 whitespace-nowrap">${entry.method}</td> <td class="py-3 px-4 break-words">${entry.narration}</td> <td class="py-3 px-4 text-right font-mono">${(entry.amount || 0).toLocaleString()}</td> <td class="py-3 px-4 text-center whitespace-nowrap"> <button data-id="${entry.id}" class="edit-btn text-orange-500 hover:text-orange-700 dark:text-orange-400 dark:hover:text-orange-300 font-semibold transition-colors mr-2">Edit</button> <button data-id="${entry.id}" class="delete-btn text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-semibold transition-colors">Delete</button> </td>`; return tr; }
    
    function updatePaginationControls(totalEntries, totalPages) { pageInfo.textContent = `Page ${viewOptions.currentPage} of ${totalPages || 1}`; prevPageBtn.disabled = viewOptions.currentPage === 1; nextPageBtn.disabled = viewOptions.currentPage >= totalPages; }
    
    function renderDashboard() { if (!appData.journals || Object.keys(appData.journals).length === 0) { dashboardMainContent.classList.add('hidden'); dashboardMessage.classList.remove('hidden'); return; }; dashboardMainContent.classList.remove('hidden'); dashboardMessage.classList.add('hidden'); const rangeText = { week: 'This Week', month: 'This Month', year: 'This Year', all: 'All Time' }; let journalTitle = "Dashboard"; if (viewOptions.currentJournalView === 'all') { journalTitle = 'All Journals'; } else if (appData.journals[viewOptions.currentJournalView]) { journalTitle = appData.journals[viewOptions.currentJournalView].name; } dashboardTitle.textContent = `${journalTitle} (${rangeText[viewOptions.dashboardDateRange]})`; const { currentPeriod, prevPeriod } = getDateRanges(viewOptions.dashboardDateRange); const allEntries = getFilteredEntries(); const currentEntries = allEntries.filter(e => { const entryDate = new Date(e.date); return entryDate >= currentPeriod.start && entryDate <= currentPeriod.end; }); const prevEntriesAll = getFilteredEntries(); const prevEntries = prevEntriesAll.filter(e => { const entryDate = new Date(e.date); return entryDate >= prevPeriod.start && entryDate <= prevPeriod.end; }); const currentIncome = currentEntries.filter(e => e.type === 'Income').reduce((sum, e) => sum + e.amount, 0); const currentExpense = currentEntries.filter(e => e.type === 'Expense').reduce((sum, e) => sum + e.amount, 0); const currentNet = currentIncome - currentExpense; const prevIncome = prevEntries.filter(e => e.type === 'Income').reduce((sum, e) => sum + e.amount, 0); const prevExpense = prevEntries.filter(e => e.type === 'Expense').reduce((sum, e) => sum + e.amount, 0); const prevNet = prevIncome - prevExpense; kpiIncomeEl.textContent = formatAmountForDashboard(currentIncome); kpiExpenseEl.textContent = formatAmountForDashboard(currentExpense); kpiNetEl.textContent = formatAmountForDashboard(currentNet); kpiIncomeCompEl.innerHTML = getComparisonHTML(currentIncome, prevIncome); kpiExpenseCompEl.innerHTML = getComparisonHTML(currentExpense, prevExpense, true); kpiNetCompEl.innerHTML = getComparisonHTML(currentNet, prevNet); updateChartButtonStyles(); let interval = 'day'; if (viewOptions.dashboardDateRange === 'all') { interval = 'quarter'; } else if (viewOptions.dashboardDateRange === 'year') { interval = 'month'; } const groupedIncome = groupDataByInterval(currentEntries.filter(e => e.type === 'Income'), interval, currentPeriod); incomeBarChartInstance = renderBarChart(incomeBarChartInstance, incomeBarChartCanvas, 'Income Over Time', groupedIncome, '#84cc16'); const groupedExpense = groupDataByInterval(currentEntries.filter(e => e.type === 'Expense'), interval, currentPeriod); expenseBarChartInstance = renderBarChart(expenseBarChartInstance, expenseBarChartCanvas, 'Expense Over Time', groupedExpense, '#ef4444'); const netBalanceData = calculateNetBalanceOverTime(currentEntries, interval, currentPeriod); netBalanceAreaChartInstance = renderAreaChart(netBalanceAreaChartInstance, netBalanceAreaChartCanvas, 'Net Balance Over Time', netBalanceData); donutChartInstance = renderDonutChart(donutChartInstance, donutChartCanvas, currentEntries, viewOptions.chartDataType); }
    
    function getComparisonHTML(current, previous, invert = false) { if (previous === 0) { return current > 0 ? `<span class="text-lime-600"> New</span>` : `<span class="text-gray-500 dark:text-gray-400">-</span>`; } const percentChange = ((current - previous) / previous) * 100; const isUp = percentChange > 0; const isDown = percentChange < 0; let colorClass = 'text-gray-500 dark:text-gray-400'; if ((isUp && !invert) || (isDown && invert)) colorClass = 'text-lime-600 dark:text-lime-400'; if ((isDown && !invert) || (isUp && invert)) colorClass = 'text-red-600 dark:text-red-400'; const arrow = isUp ? '' : ''; const formattedPercent = Math.abs(percentChange).toFixed(0); if (Math.abs(formattedPercent) < 1) return `<span class="text-gray-500 dark:text-gray-400">~ 0%</span>`; return `<span class="${colorClass}">${arrow} ${formattedPercent}% vs previous period</span>`; }
    
    function getDateRanges(rangeKey) { const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); let currentPeriod = { start: new Date(), end: new Date() }; let prevPeriod = { start: new Date(), end: new Date() }; switch (rangeKey) { case 'week': currentPeriod.start = new Date(today); currentPeriod.start.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)); currentPeriod.end = new Date(currentPeriod.start); currentPeriod.end.setDate(currentPeriod.start.getDate() + 6); prevPeriod.start = new Date(currentPeriod.start); prevPeriod.start.setDate(currentPeriod.start.getDate() - 7); prevPeriod.end = new Date(currentPeriod.end); prevPeriod.end.setDate(currentPeriod.end.getDate() - 7); break; case 'year': currentPeriod.start = new Date(today.getFullYear(), 0, 1); currentPeriod.end = new Date(today.getFullYear(), 11, 31); prevPeriod.start = new Date(today.getFullYear() - 1, 0, 1); prevPeriod.end = new Date(today.getFullYear() - 1, 11, 31); break; case 'all': const allEntries = getFilteredEntries(); if (allEntries.length > 0) { const firstDate = new Date(allEntries.sort((a, b) => new Date(a.date) - new Date(b.date))[0].date); currentPeriod.start = new Date(firstDate.getFullYear(), 0, 1); } else { currentPeriod.start = new Date(today.getFullYear(), 0, 1); } currentPeriod.end = new Date(today.getFullYear(), 11, 31); prevPeriod.start = new Date(currentPeriod.start); prevPeriod.start.setFullYear(prevPeriod.start.getFullYear() - 1); prevPeriod.end = new Date(currentPeriod.end); prevPeriod.end.setFullYear(prevPeriod.end.getFullYear() - 1); break; case 'month': default: currentPeriod.start = new Date(today.getFullYear(), today.getMonth(), 1); currentPeriod.end = new Date(today.getFullYear(), today.getMonth() + 1, 0); prevPeriod.start = new Date(today.getFullYear(), today.getMonth() - 1, 1); prevPeriod.end = new Date(today.getFullYear(), today.getMonth(), 0); break; } return { currentPeriod, prevPeriod }; }
    
    function updateChartButtonStyles() { kpiRangeBtns.forEach(btn => { if (btn.dataset.range === viewOptions.dashboardDateRange) { btn.classList.add('active'); } else { btn.classList.remove('active'); } }); Object.values(chartTypeBtns).forEach(btn => btn.classList.remove('active')); chartTypeBtns[viewOptions.chartDataType].classList.add('active'); }
    
    function renderDonutChart(instance, canvas, entries, type) { 
        if (instance) instance.destroy(); 
        const isDarkMode = document.documentElement.classList.contains('dark');
        const textColor = isDarkMode ? '#d1d5db' : '#4b5563';
        const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1); 
        const dataMap = entries.filter(e => e.type === capitalizedType).reduce((acc, entry) => { 
            const key = entry.method || 'Other'; 
            acc[key] = (acc[key] || 0) + entry.amount; 
            return acc; 
        }, {}); 
        const labels = Object.keys(dataMap); 
        const data = Object.values(dataMap); 
        const noDataMessage = capitalizedType === 'Income' ? 'No income data for this period.' : 'No expense data for this period.'; 
        
        if (labels.length === 0) { 
            const ctx = canvas.getContext('2d'); 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            ctx.save(); 
            ctx.textAlign = 'center'; 
            ctx.textBaseline = 'middle'; 
            ctx.fillStyle = textColor; 
            ctx.font = '14px "Inter", sans-serif'; 
            ctx.fillText(noDataMessage, canvas.width / 2, canvas.height / 2); 
            ctx.restore(); 
            return null; 
        } 
        
        const colorPalettes = { Expense: ['#f97316', '#facc15', '#2563eb'], Income: ['#48e7b7', '#7ae03f', '#10b981'] }; 
        
        return new Chart(canvas, { 
            type: 'doughnut', 
            data: { labels, datasets: [{ label: capitalizedType, data, backgroundColor: colorPalettes[capitalizedType] }] }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: true, position: 'bottom', labels: { color: textColor } } },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const clickedElementIndex = elements[0].index;
                        const clickedLabel = labels[clickedElementIndex];
                        
                        handleTabSwitch('manage');
                        
                        filterMethodSelect.value = clickedLabel;
                        viewOptions.filterByMethod = clickedLabel;
                        filterTypeSelect.value = capitalizedType;
                        viewOptions.filterByType = capitalizedType;
                        
                        searchInput.value = '';
                        viewOptions.searchTerm = '';
                        startDateInput.value = '';
                        endDateInput.value = '';
                        viewOptions.startDate = null;
                        viewOptions.endDate = null;
                        
                        renderTable();
                    }
                }
            } 
        }); 
    }
    
    function groupDataByInterval(entries, interval, period) { const dataMap = new Map(); let currentDate = new Date(period.start); while(currentDate <= period.end) { const key = getIntervalKey(currentDate, interval); dataMap.set(key, 0); if (interval === 'day') { currentDate.setDate(currentDate.getDate() + 1); } else if (interval === 'month') { currentDate.setMonth(currentDate.getMonth() + 1); } else if (interval === 'quarter') { currentDate.setMonth(currentDate.getMonth() + 3); } } entries.forEach(entry => { const entryDate = new Date(entry.date); entryDate.setMinutes(entryDate.getMinutes() + entryDate.getTimezoneOffset()); const key = getIntervalKey(entryDate, interval); if(dataMap.has(key)) { dataMap.set(key, dataMap.get(key) + entry.amount); } }); const labels = [...dataMap.keys()].map(key => { if(interval === 'day') { const [y, m, d] = key.split('-'); return `${d}/${m}`; } if (interval === 'month') { const [y, m] = key.split('-'); return new Date(y, m-1).toLocaleString('default', { month: 'short' }); } if (interval === 'quarter') { const [y, q] = key.split('-'); return `${q} '${y.slice(2)}`; } }); return { labels, data: [...dataMap.values()]}; }
    
    function calculateNetBalanceOverTime(entries, interval, period) { const sortedEntries = [...entries].sort((a,b) => new Date(a.date) - new Date(b.date)); const balanceMap = new Map(); let currentDate = new Date(period.start); while(currentDate <= period.end) { const key = getIntervalKey(currentDate, interval); balanceMap.set(key, 0); if (interval === 'day') { currentDate.setDate(currentDate.getDate() + 1); } else if (interval === 'month') { currentDate.setMonth(currentDate.getMonth() + 1); } else if (interval === 'quarter') { currentDate.setMonth(currentDate.getMonth() + 3); } } sortedEntries.forEach(entry => { const entryDate = new Date(entry.date); entryDate.setMinutes(entryDate.getMinutes() + entryDate.getTimezoneOffset()); const key = getIntervalKey(entryDate, interval); const value = entry.type === 'Income' ? entry.amount : -entry.amount; if (balanceMap.has(key)) { balanceMap.set(key, balanceMap.get(key) + value); } }); let cumulativeBalance = 0; const finalData = []; balanceMap.forEach(value => { cumulativeBalance += value; finalData.push(cumulativeBalance); }); const labels = [...balanceMap.keys()].map(key => { if(interval === 'day') { const [y, m, d] = key.split('-'); return `${d}/${m}`; } if (interval === 'month') { const [y, m] = key.split('-'); return new Date(y, m-1).toLocaleString('default', { month: 'short' }); } if (interval === 'quarter') { const [y, q] = key.split('-'); return `${q} '${y.slice(2)}`; } }); return { labels, data: finalData }; }
    
    function renderBarChart(instance, canvas, label, chartData, color) { 
        if (instance) instance.destroy(); 
        const isDarkMode = document.documentElement.classList.contains('dark');
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDarkMode ? '#d1d5db' : '#4b5563';
        return new Chart(canvas, { type: 'bar', data: { labels: chartData.labels, datasets: [{ label, data: chartData.data, backgroundColor: color }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: label, color: textColor }, legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { color: gridColor }, ticks: { color: textColor } } } } }); 
    }
    
    function renderAreaChart(instance, canvas, label, chartData) { 
        if (instance) instance.destroy();
        const isDarkMode = document.documentElement.classList.contains('dark');
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDarkMode ? '#d1d5db' : '#4b5563'; 
        const areaBgColor = isDarkMode ? 'rgba(99, 102, 241, 0.2)' : 'rgba(79, 70, 229, 0.1)';
        const borderColor = isDarkMode ? '#818cf8' : '#4338ca';
        return new Chart(canvas, { type: 'line', data: { labels: chartData.labels, datasets: [{ label, data: chartData.data, fill: true, borderColor: borderColor, backgroundColor: areaBgColor, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: label, color: textColor }, legend: { display: false } }, scales: { y: { beginAtZero: false, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { color: gridColor }, ticks: { color: textColor } } } } }); 
    }
    
    function assembleAndValidateDate(dayInput, monthInput, yearInput) { let day = parseInt(dayInput.value, 10); let month = parseInt(monthInput.value, 10); let year = parseInt(yearInput.value, 10); if (!day || !month || !year || year.toString().length < 4) { showToast("Please enter a full date (DD, MM, YYYY).", 'error'); return null; } if (month < 1) month = 1; if (month > 12) month = 12; const daysInMonth = new Date(year, month, 0).getDate(); if (day > daysInMonth) { showToast(`Warning: ${new Date(year, month - 1).toLocaleString('default', { month: 'long' })} only has ${daysInMonth} days. Correcting date.`, 'info'); day = daysInMonth; } if (day < 1) day = 1; dayInput.value = String(day).padStart(2, '0'); monthInput.value = String(month).padStart(2, '0'); yearInput.value = String(year); return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`; }
    
    function resetAllFilters() { sortBySelect.value = 'date_desc'; filterTypeSelect.value = 'all'; filterMethodSelect.value = 'all'; searchInput.value = ''; startDateInput.value = ''; endDateInput.value = ''; viewOptions.sortBy = 'date_desc'; viewOptions.filterByType = 'all'; viewOptions.filterByMethod = 'all'; viewOptions.searchTerm = ''; viewOptions.startDate = null; viewOptions.endDate = null; viewOptions.currentPage = 1; selectedEntryIds.clear(); renderTable(); }

    function populateNarrationSuggestions() {
        if (!appData.journals) return;
        const suggestions = new Set();
        Object.values(appData.journals).forEach(journal => {
            (journal.entries || []).forEach(entry => {
                if (entry.narration) suggestions.add(entry.narration);
            });
        });
        narrationSuggestions.innerHTML = [...suggestions].map(s => `<option value="${s}"></option>`).join('');
    }

    function formatAmountInput(input) {
        let value = input.value;
        let numericValue = value.replace(/[^0-9]/g, '');
        if (numericValue) {
            input.value = parseInt(numericValue, 10).toLocaleString('en-US');
        } else {
            input.value = '';
        }
    }


    // --- CRUD & JOURNAL MANAGEMENT ---
    function isJournalNameTaken(name, excludingId = null) { const lowerCaseName = name.trim().toLowerCase(); for (const id in appData.journals) { if (id === excludingId) continue; if (appData.journals[id].name.toLowerCase() === lowerCaseName) { return true; } } return false; }
    
    function showInputModal(title, message, defaultValue, onConfirm) {
        inputModalTitle.textContent = title;
        inputModalMessage.textContent = message;
        inputModalField.value = defaultValue;
        inputConfirmCallback = onConfirm;
        inputModal.classList.remove('hidden');
        inputModalField.focus();
    }

    function createNewJournal() {
        showInputModal("Create New Journal", "Enter a name for the new journal:", "New Journal", (journalName) => {
            if (!journalName || journalName.trim() === '') return;
            if (isJournalNameTaken(journalName)) {
                showToast(`A journal named '${journalName.trim()}' already exists.`, "error");
                return;
            }
            const newId = `journal_${Date.now()}`;
            if (!appData.journals) appData.journals = {};
            appData.journals[newId] = { name: journalName.trim(), entries: [], lastModified: new Date().toISOString() };
            appData.activeJournalId = newId;
            viewOptions.currentJournalView = newId;
            
            saveDataToFirestore().then(() => {
                logActivity('create_journal', { journalName: journalName.trim() });
                showToast("Journal created!", "success");
                updateUI();
            });
        });
    }

    function renameActiveJournal(journalId) {
        const activeJournal = appData.journals[journalId];
        if (!activeJournal) return;
        const oldName = activeJournal.name;
        
        showInputModal("Rename Journal", `Enter new name for "${oldName}":`, oldName, (newName) => {
            if (!newName || newName.trim() === '' || newName.trim() === oldName) return;
            if (isJournalNameTaken(newName, journalId)) {
                showToast(`A journal named '${newName.trim()}' already exists.`, "error");
                return;
            }
            activeJournal.name = newName.trim();
            
            saveDataToFirestore(true).then(() => {
                logActivity('rename_journal', { oldName, newName: newName.trim() });
                showToast("Journal renamed!", "success");
                updateUI();
            });
        });
    }

    async function deleteActiveJournal(journalId) {
        const journalToDelete = appData.journals[journalId];
        if (!journalId || !journalToDelete) return;

        const journalName = journalToDelete.name;
        delete appData.journals[journalId];

        if (appData.activeJournalId === journalId || viewOptions.currentJournalView === journalId) {
            const remainingIds = Object.keys(appData.journals);
            const newActiveId = remainingIds.length > 0 ? remainingIds[0] : 'all';
            appData.activeJournalId = newActiveId;
            viewOptions.currentJournalView = newActiveId;
        }
        
        updateUI();

        try {
            const orgDocRef = doc(db, "organizations", currentUserProfile.organizationId);
            const updatePayload = {
                [`journals.${journalId}`]: deleteField(),
                activeJournalId: appData.activeJournalId
            };

            await updateDoc(orgDocRef, updatePayload);
            logActivity('delete_journal', { journalName });
            showToast(`'${journalName}' deleted.`, "info");
        } catch (error) {
            console.error("Error deleting journal from Firestore: ", error);
            showToast("Error deleting journal. Re-syncing data.", "error");
            loadDataFromFirestore();
        }
    }

    function hideUndoToast() {
        if (currentUndoToast) {
            currentUndoToast.classList.remove('show');
            currentUndoToast.classList.add('hide');
            currentUndoToast.addEventListener('animationend', () => {
                if (currentUndoToast) currentUndoToast.remove();
                currentUndoToast = null;
            }, { once: true });
        }
        clearTimeout(undoTimeout);
        undoCache = null;
    }

    function showUndoToast() {
        hideUndoToast(); // Clear any existing undo toast first

        const toast = document.createElement('div');
        toast.className = 'undo-bar show pointer-events-auto bg-gray-800 text-white dark:bg-gray-700 shadow-lg rounded-md w-full sm:w-1/3 p-4 flex justify-between items-center';
        
        const messageEl = document.createElement('span');
        messageEl.textContent = 'Entry deleted.';
        toast.appendChild(messageEl);

        const actionBtn = document.createElement('button');
        actionBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg text-sm';
        actionBtn.textContent = 'Undo';
        actionBtn.onclick = (e) => {
            e.stopPropagation();
            undoDelete();
        };
        toast.appendChild(actionBtn);
        
        currentUndoToast = toast;
        undoToastContainer.appendChild(toast);

        undoTimeout = setTimeout(() => {
            hideUndoToast();
        }, 7000);
    }
    
    function undoDelete() {
        if (!undoCache) return;
        const { journalId, entry, originalIndex } = undoCache;
        if (appData.journals[journalId]) {
            appData.journals[journalId].entries.splice(originalIndex, 0, entry);
            saveDataToFirestore(true).then(() => {
                showToast("Entry restored.", "success");
                logActivity('undo_delete_entry', { narration: entry.narration });
            });
        }
        hideUndoToast();
    }
    
    function addEntry(e) {
        e.preventDefault();
        const activeJournalId = viewOptions.currentJournalView;
        if (activeJournalId === 'all' || !appData.journals[activeJournalId]) {
            showToast("Please select a specific journal to add an entry.", "error");
            return;
        }
        const activeJournal = appData.journals[activeJournalId];
        const formattedDate = assembleAndValidateDate(dateDayInput, dateMonthInput, dateYearInput);
        if (!formattedDate) return;

        const newEntry = {
            id: `entry_${Date.now()}`,
            date: formattedDate,
            type: typeSelect.value,
            method: methodSelect.value,
            narration: narrationInput.value.trim(),
            amount: parseFloat(amountInput.value.replace(/,/g, '')) || 0
        };

        if (!activeJournal.entries) activeJournal.entries = [];
        activeJournal.entries.push(newEntry);
        
        saveDataToFirestore(true).then(() => {
            logActivity('create_entry', { narration: newEntry.narration, amount: newEntry.amount, type: newEntry.type, journalName: activeJournal.name });
            showToast("Entry added", "success");
            
            narrationInput.value = '';
            amountInput.value = '';
            
            narrationInput.focus();
        });
    }
    
    function openEditModal(entryId) { let entry, journalId; for (const jId in appData.journals) { const foundEntry = appData.journals[jId].entries.find(e => e.id === entryId); if (foundEntry) { entry = foundEntry; journalId = jId; break; } } if (!entry) return; document.getElementById('editEntryId').value = entry.id; const [year, month, day] = entry.date.split('-'); editDateDayInput.value = day; editDateMonthInput.value = month; editDateYearInput.value = year; document.getElementById('editType').value = entry.type; document.getElementById('editMethod').value = entry.method; document.getElementById('editNarration').value = entry.narration; editAmountInput.value = (entry.amount || 0).toLocaleString('en-US'); editEntryModal.classList.remove('hidden'); }
    
    function updateEntry(e) { e.preventDefault(); const entryId = document.getElementById('editEntryId').value; if (!entryId) return; let entryIndex, journalId; for (const jId in appData.journals) { const index = appData.journals[jId].entries.findIndex(e => e.id === entryId); if (index !== -1) { entryIndex = index; journalId = jId; break; } } if (entryIndex === undefined) return; const formattedDate = assembleAndValidateDate(editDateDayInput, editDateMonthInput, editDateYearInput); if (!formattedDate) return; appData.journals[journalId].entries[entryIndex] = { id: entryId, date: formattedDate, type: document.getElementById('editType').value, method: document.getElementById('editMethod').value, narration: document.getElementById('editNarration').value.trim(), amount: parseFloat(editAmountInput.value.replace(/,/g, '')) || 0 }; saveDataToFirestore(true).then(() => { logActivity('update_entry', { narration: appData.journals[journalId].entries[entryIndex].narration, journalName: appData.journals[journalId].name }); showToast("Entry updated", "success"); }); editEntryModal.classList.add('hidden'); }
    
    function deleteEntry(entryId) {
        let journalId, entryIndex, deletedEntry;
        for (const jId in appData.journals) {
            const index = appData.journals[jId].entries.findIndex(e => e.id === entryId);
            if (index > -1) {
                journalId = jId;
                entryIndex = index;
                deletedEntry = { ...appData.journals[jId].entries[index] };
                break;
            }
        }
        if (!journalId) return;

        undoCache = { journalId, entry: deletedEntry, originalIndex: entryIndex };
        appData.journals[journalId].entries.splice(entryIndex, 1);
        
        saveDataToFirestore(true).then(() => {
            logActivity('delete_entry', { narration: deletedEntry.narration, journalName: appData.journals[journalId].name });
            showUndoToast();
        });
    }
    
    function updateBulkDeleteButton() { const count = selectedEntryIds.size; bulkDeleteBtn.textContent = `Delete Selected (${count})`; bulkDeleteBtn.classList.toggle('hidden', count === 0); }
    
    function bulkDeleteEntries() { const count = selectedEntryIds.size; for (const jId in appData.journals) { appData.journals[jId].entries = appData.journals[jId].entries.filter(entry => !selectedEntryIds.has(entry.id)); } selectedEntryIds.clear(); saveDataToFirestore(true).then(() => { logActivity('bulk_delete_entries', { count }); showToast(`${count} entries deleted`, "info"); }); }
    
    function showConfirmationModal(message, onConfirm) { modalMessage.textContent = message; confirmCallback = onConfirm; confirmationModal.classList.remove('hidden'); }
    
    function getYearsFromEntries(entries) { if (!entries || entries.length === 0) return new Set(); return new Set(entries.map(e => e.date.substring(0, 4))); }
    
    function canJournalsBeMerged(sourceId, destId) { const sourceJournal = appData.journals[sourceId]; const destJournal = appData.journals[destId]; if (!sourceJournal || !destJournal) return false; const sourceYears = getYearsFromEntries(sourceJournal.entries); const destYears = getYearsFromEntries(destJournal.entries); if (sourceYears.size === 0 || destYears.size === 0) return true; const allYears = new Set([...sourceYears, ...destYears]); return allYears.size === 1; }
    
    function toggleMergeMode() { isMergeModeActive = !isMergeModeActive; mergeDestinationId = null; if (isMergeModeActive) { mergeJournalBtn.textContent = "Cancel Merge"; mergeJournalBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700'); mergeJournalBtn.classList.add('bg-red-600', 'hover:bg-red-700'); mergeStatusMessage.textContent = "Step 1: Select the journal to merge INTO (Destination)."; mergeStatusMessage.classList.remove('hidden'); } else { mergeJournalBtn.textContent = "Merge Journals"; mergeJournalBtn.classList.remove('bg-red-600', 'hover:bg-red-700'); mergeJournalBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); mergeStatusMessage.classList.add('hidden'); } renderJournalCards(); }
    
    function handleMergeSelection(selectedId) { 
        if (!mergeDestinationId) { 
            mergeDestinationId = selectedId; 
            mergeStatusMessage.textContent = `Step 2: Select a journal to merge FROM (Source).`; 
            renderJournalCards(); 
        } else { 
            const sourceId = selectedId; 
            const destId = mergeDestinationId; 
            const sourceName = appData.journals[sourceId].name; 
            const destName = appData.journals[destId].name; 
            const confirmationMessage = `Merge all entries from '${sourceName}' into '${destName}'? The '${sourceName}' journal will be deleted. This cannot be undone.`; 
            
            showConfirmationModal(confirmationMessage, async () => {
                try {
                    const orgDocRef = doc(db, "organizations", currentUserProfile.organizationId);
                    const sourceEntries = appData.journals[sourceId].entries || [];
                    const destEntries = appData.journals[destId].entries || [];
                    const mergedEntries = [...destEntries, ...sourceEntries];

                    appData.journals[destId].entries = mergedEntries;
                    appData.journals[destId].lastModified = new Date().toISOString();
                    delete appData.journals[sourceId];
                    
                    toggleMergeMode(); 
                    
                    const batch = writeBatch(db);
                    
                    batch.update(orgDocRef, {
                        [`journals.${destId}.entries`]: mergedEntries,
                        [`journals.${destId}.lastModified`]: new Date().toISOString()
                    });

                    batch.update(orgDocRef, {
                        [`journals.${sourceId}`]: deleteField()
                    });

                    await batch.commit();

                    logActivity('merge_journals', { sourceName, destName });
                    showToast("Journals merged successfully!", "success");

                } catch (error) {
                    console.error("Error merging journals: ", error);
                    showToast("Error merging journals. Re-syncing data.", "error");
                    toggleMergeMode(); 
                    loadDataFromFirestore(); 
                }
            });
        } 
    }
    
    // --- ADMIN PANEL LOGIC ---
    async function loadUserActivities() {
        if (currentUserProfile?.role !== 'admin' || !currentUserProfile.organizationId) {
            activityLogContainer.innerHTML = `<p class="text-red-500 text-center">Cannot load activities: Admin status or organization is missing.</p>`;
            return;
        };
        activityLogContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center">Loading activity log...</p>`;
        try {
            const activitiesColRef = collection(db, 'activity_logs');
            const q = query(activitiesColRef, 
                where("organizationId", "==", currentUserProfile.organizationId),
                orderBy("timestamp", "desc"),
                limit(100)
            );
            const querySnapshot = await getDocs(q);
            const activities = [];
            querySnapshot.forEach(doc => activities.push({ id: doc.id, ...doc.data() }));
            
            if (activities.length === 0) {
                activityLogContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center">No user activities recorded yet.</p>`;
                return;
            }

            activityLogContainer.innerHTML = activities.map(log => {
                const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString() : 'Just now';
                let detailsHtml = '';
                if (log.details) {
                    detailsHtml = Object.entries(log.details)
                        .map(([key, value]) => `<span class="text-xs text-gray-500 dark:text-gray-400 mr-2"><strong>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</strong> ${value}</span>`)
                        .join('');
                }

                return `
                    <div class="p-3 rounded-lg bg-gray-50 border border-gray-200 dark:bg-gray-800/50 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-gray-800 dark:text-gray-200">${log.action.replace(/_/g, ' ').toUpperCase()}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${timestamp}</p>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
                            by <span class="font-medium text-orange-600 dark:text-orange-400">${log.userEmail}</span>
                        </p>
                        <div class="mt-2">
                           ${detailsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error("Error loading activities:", error.message);
            if (error.code === 'failed-precondition') {
                 activityLogContainer.innerHTML = `<p class="text-red-500 text-center">Failed to load activities. A database index is required. Please check the developer console for a link to create it.</p>`;
            } else {
                 activityLogContainer.innerHTML = `<p class="text-red-500 text-center">Failed to load activities. Check Firestore rules.</p>`;
            }
        }
    }

    // --- TAB CONTROL & TOUR ---
    const handleTabSwitch = (activeTabKey) => { 
        if (tour && tour.isActive()) { tour.cancel(); } 
        
        hideUndoToast();

        if (activeTabKey !== 'dashboard') {
            viewOptions.dashboardDateRange = 'month';
        }

        if (activeTabKey !== 'manage' && viewOptions.currentJournalView === 'all') { 
            const journalToRestore = lastActiveSingleJournalId || (Object.keys(appData.journals || {})[0]); 
            if (journalToRestore) { 
                setActiveJournalView(journalToRestore); 
            }
        }

        if(isMergeModeActive) { toggleMergeMode(); } 
        
        Object.values(tabContents).forEach(content => content.classList.add('hidden')); 
        Object.values(tabButtons).forEach(button => { 
            button.classList.remove('bg-orange-500', 'text-white'); 
            button.classList.add('text-gray-500', 'hover:bg-gray-200', 'dark:text-gray-400', 'dark:hover:bg-gray-700'); 
        }); 

        tabContents[activeTabKey].classList.remove('hidden'); 

        if(tabButtons[activeTabKey]) {
            tabButtons[activeTabKey].classList.add('bg-orange-500', 'text-white'); 
            tabButtons[activeTabKey].classList.remove('text-gray-500', 'hover:bg-gray-200', 'dark:text-gray-400', 'dark:hover:bg-gray-700'); 
        }
        
        if (activeTabKey === 'admin') {
            loadUserActivities();
        }

        const allTimeBtn = document.querySelector('.kpi-range-btn[data-range="all"]');
        if (allTimeBtn) {
            allTimeBtn.disabled = activeTabKey !== 'dashboard';
        }

        const bulkDeleteWrapper = document.getElementById('bulk-delete-wrapper');
        const entriesTable = document.getElementById('entriesTable');
        if (bulkDeleteWrapper) {
            bulkDeleteWrapper.style.display = activeTabKey === 'manage' ? 'flex' : 'none';
        }
        if (entriesTable) {
            entriesTable.classList.toggle('selection-hidden', activeTabKey !== 'manage');
        }
        
        if(activeTabKey === 'data' || activeTabKey === 'manage') {
            renderJournalCards();
        }

        if (activeTabKey !== 'manage' && selectedEntryIds.size > 0) {
            selectedEntryIds.clear();
            updateBulkDeleteButton();
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
        }
    };
    Object.keys(tabButtons).forEach(key => { tabButtons[key].addEventListener('click', () => handleTabSwitch(key)); });
    adminMenuBtn.addEventListener('click', () => { handleTabSwitch('admin'); userMenu.classList.add('hidden'); });

    Object.keys(chartTypeBtns).forEach(key => { chartTypeBtns[key].addEventListener('click', () => { viewOptions.chartDataType = key; renderDashboard(); }); });
    kpiRangeBtns.forEach(btn => { 
        btn.addEventListener('click', () => { 
            viewOptions.dashboardDateRange = btn.dataset.range; 
            if (btn.dataset.range === 'all') { 
                if (viewOptions.currentJournalView !== 'all') { 
                    lastActiveSingleJournalId = viewOptions.currentJournalView; 
                } 
                setActiveJournalView('all', true); 
            } else { 
                if (viewOptions.currentJournalView === 'all' && lastActiveSingleJournalId) { 
                    setActiveJournalView(lastActiveSingleJournalId, true); 
                } else { 
                    renderDashboard(); 
                } 
            } 
        }) 
    });
    
    // --- EVENT LISTENERS ---
    userMenuButton.addEventListener('click', (e) => { e.stopPropagation(); userMenu.classList.toggle('hidden'); });
    window.addEventListener('click', (e) => { if (!userMenu.classList.contains('hidden') && !userMenuButton.contains(e.target)) { userMenu.classList.add('hidden'); } });
    function enforceMinMax(input) { const value = parseInt(input.value, 10); const min = parseInt(input.min, 10); const max = parseInt(input.max, 10); if (value > max) input.value = max; }
    function setupDateInputListeners(dayEl, monthEl, yearEl, pickerBtn, nativePicker) { dayEl.addEventListener('input', () => enforceMinMax(dayEl)); monthEl.addEventListener('input', () => enforceMinMax(monthEl)); yearEl.addEventListener('input', () => { if (yearEl.value.length > 4) { yearEl.value = yearEl.value.slice(0, 4); } }); dayEl.addEventListener('keyup', () => { if (dayEl.value.length === 2) monthEl.focus(); }); monthEl.addEventListener('keyup', () => { if (monthEl.value.length === 2) yearEl.focus(); }); pickerBtn.addEventListener('click', () => { try { nativePicker.showPicker(); } catch (error) { showToast("Your browser doesn't support this feature.", "error"); } }); nativePicker.addEventListener('change', (e) => { if (e.target.value) { const [year, month, day] = e.target.value.split('-'); dayEl.value = day; monthEl.value = month; yearEl.value = year; } }); }
    setupDateInputListeners(dateDayInput, dateMonthInput, dateYearInput, datePickerBtn, nativeDatePicker);
    setupDateInputListeners(editDateDayInput, editDateMonthInput, editDateYearInput, editDatePickerBtn, editNativeDatePicker);
    amountInput.addEventListener('input', () => formatAmountInput(amountInput));
    editAmountInput.addEventListener('input', () => formatAmountInput(editAmountInput));
    searchInput.addEventListener('input', (e) => { viewOptions.searchTerm = e.target.value; viewOptions.currentPage = 1; renderTable(); });
    [sortBySelect, filterTypeSelect, filterMethodSelect].forEach(el => { el.addEventListener('change', () => { viewOptions.sortBy = sortBySelect.value; viewOptions.filterByType = filterTypeSelect.value; viewOptions.filterByMethod = filterMethodSelect.value; viewOptions.currentPage = 1; renderTable(); }); });
    filterByDateBtn.addEventListener('click', () => { viewOptions.startDate = startDateInput.value; viewOptions.endDate = endDateInput.value; viewOptions.currentPage = 1; renderTable(); });
    clearDateFilterBtn.addEventListener('click', () => { startDateInput.value = ''; endDateInput.value = ''; viewOptions.startDate = null; viewOptions.endDate = null; viewOptions.currentPage = 1; renderTable(); });
    resetFiltersBtn.addEventListener('click', resetAllFilters);
    journalCardsContainer.addEventListener('click', (e) => { 
        const card = e.target.closest('.journal-card');
        if (!card || card.classList.contains('disabled-card')) return; 
        const journalId = card.dataset.id;
        
        const isAdmin = currentUserProfile?.role === 'admin';

        if (isMergeModeActive) { 
            if (isAdmin && e.target.classList.contains('select-merge-btn')) { 
                handleMergeSelection(journalId); 
            }
            return;
        }

        const isSelectAction = e.target.classList.contains('select-journal-btn') || !e.target.closest('button');
        const isRenameAction = e.target.classList.contains('rename-journal-btn');
        const isDeleteAction = e.target.classList.contains('delete-journal-btn');

        if (isSelectAction) { 
            setActiveJournalView(journalId, true); 
        } else if (isRenameAction) { 
            renameActiveJournal(journalId); 
        } else if (isDeleteAction && isAdmin) { 
            const name = appData.journals[journalId]?.name;
            if (name) showConfirmationModal(`Delete '${name}' and all its entries? This cannot be undone.`, () => deleteActiveJournal(journalId)); 
        } 
    });
    manageJournalSelect.addEventListener('change', (e) => {
        setActiveJournalView(e.target.value, true);
    });
    prevPageBtn.addEventListener('click', () => { if (viewOptions.currentPage > 1) { viewOptions.currentPage--; renderTable(); } });
    nextPageBtn.addEventListener('click', () => { viewOptions.currentPage++; renderTable(); });
    entryForm.addEventListener('submit', addEntry);
    editEntryForm.addEventListener('submit', updateEntry);
    createJournalBtn.addEventListener('click', createNewJournal);
    mergeJournalBtn.addEventListener('click', toggleMergeMode);
    bulkDeleteBtn.addEventListener('click', () => { showConfirmationModal(`Are you sure you want to delete ${selectedEntryIds.size} selected entries? This cannot be undone.`, bulkDeleteEntries); });
    const handleTableClick = (e) => { if (e.target.classList.contains('delete-btn')) { showConfirmationModal("Are you sure you want to delete this entry?", () => deleteEntry(e.target.dataset.id)); } if (e.target.classList.contains('edit-btn')) { openEditModal(e.target.dataset.id); } if (e.target.classList.contains('row-checkbox')) { const id = e.target.dataset.id; if (e.target.checked) { selectedEntryIds.add(id); } else { selectedEntryIds.delete(id); } updateBulkDeleteButton(); } };
    tableBody.addEventListener('click', handleTableClick);
    recentEntriesBody.addEventListener('click', handleTableClick);
    selectAllCheckbox.addEventListener('change', (e) => { const checkboxes = tableBody.querySelectorAll('.row-checkbox'); checkboxes.forEach(checkbox => { const id = checkbox.dataset.id; checkbox.checked = e.target.checked; if (e.target.checked) { selectedEntryIds.add(id); } else { selectedEntryIds.delete(id); } }); updateBulkDeleteButton(); });
    modalConfirmBtn.addEventListener('click', () => { if (typeof confirmCallback === 'function') { confirmCallback(); confirmCallback = null; } confirmationModal.classList.add('hidden'); });
    modalCancelBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
    inputModalForm.addEventListener('submit', (e) => { e.preventDefault(); if (typeof inputConfirmCallback === 'function') { inputConfirmCallback(inputModalField.value); } inputModal.classList.add('hidden'); inputConfirmCallback = null; });
    inputModalCancelBtn.addEventListener('click', () => { inputModal.classList.add('hidden'); inputConfirmCallback = null; });
    undoActionBtn.addEventListener('click', undoDelete);
    editCancelBtn.addEventListener('click', () => editEntryModal.classList.add('hidden'));
    importBackupBtn.addEventListener('click', () => fileImporter.click());
    fileImporter.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { importedDataCache = JSON.parse(e.target.result); if (importedDataCache && importedDataCache.journals) { importOptionsModal.classList.remove('hidden'); } else { throw new Error("Invalid backup file format."); } } catch (err) { showToast(err.message, "error"); importedDataCache = null; } }; reader.readAsText(file); event.target.value = null; });
    importCancelBtn.addEventListener('click', () => { importOptionsModal.classList.add('hidden'); importedDataCache = null; });
    importMergeBtn.addEventListener('click', () => { if (!importedDataCache || !importedDataCache.journals) return; const journalCount = Object.keys(importedDataCache.journals).length; Object.keys(importedDataCache.journals).forEach((journalId, index) => { const journalToImport = importedDataCache.journals[journalId]; let finalName = journalToImport.name.trim(); let counter = 1; while (isJournalNameTaken(finalName)) { finalName = `${journalToImport.name.trim()} (${counter})`; counter++; } const newJournal = { ...journalToImport, name: finalName, entries: journalToImport.entries || [] }; const newId = `journal_imported_${Date.now()}_${index}`; if(!appData.journals) appData.journals = {}; appData.journals[newId] = newJournal; }); saveDataToFirestore().then(() => { logActivity('import_data', { type: 'merge', journalsImported: journalCount }); showToast("Backup data merged successfully!", "success"); importOptionsModal.classList.add('hidden'); importedDataCache = null; }); });
    importReplaceBtn.addEventListener('click', () => { if (!importedDataCache) return; importOptionsModal.classList.add('hidden'); showConfirmationModal( "This will permanently delete ALL your current cloud data and replace it with this backup. This cannot be undone.", () => { appData = importedDataCache; saveDataToFirestore().then(() => { logActivity('import_data', { type: 'replace' }); showToast("Backup imported successfully!", "success"); importedDataCache = null; }); }); });
    downloadBackupBtn.addEventListener('click', () => { if (!currentUser) return; const dataStr = JSON.stringify(appData, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `tck_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });
       
    // START: HELP TOUR LOGIC
    function startTour(context) {
        if (tour && tour.isActive()) { tour.cancel(); }
        tour = new Shepherd.Tour({ useModalOverlay: true, defaultStepOptions: { scrollTo: { behavior: 'smooth', block: 'center' }, cancelIcon: { enabled: true, label: 'Close tour' }, } });
        const buttons = { first: [{ action() { return this.cancel(); }, classes: 'shepherd-button-secondary', text: 'Exit' }, { action() { return this.next(); }, text: 'Next &rarr;' }], middle: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: '&larr; Back' }, { action() { return this.next(); }, text: 'Next &rarr;' }], last: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: '&larr; Back' }, { action() { return this.complete(); }, text: 'Finish' }] };
        const loginSteps = [ { id: 'login-1', title: 'Welcome!', text: 'Enter your email address to begin. If you don\'t have an account, you can create one in the next step.', attachTo: { element: '#email', on: 'bottom' } }, { id: 'login-2', title: 'Create or Sign In', text: 'Click "Create account" if you are a new user, or "Next" to sign in with your password.', attachTo: { element: '#next-btn', on: 'bottom' } } ];
        const dashboardSteps = [ { id: 'dash-1', title: 'Welcome to the Dashboard', text: 'This is your main overview. Let\'s take a quick look at the key features.', attachTo: { element: '#dashboard-title', on: 'bottom' } }, { id: 'dash-2', title: 'Key Performance Indicators (KPIs)', text: 'These cards show your total income, expenses, and net balance for the selected time period.', attachTo: { element: '#kpi-cards', on: 'bottom' } }, { id: 'dash-3', title: 'Date Range Filters', text: 'Use these buttons to change the time period for all the data and charts on this dashboard.', attachTo: { element: '#dashboard-range-selector', on: 'bottom' } }, { id: 'dash-4', title: 'Visual Charts', text: 'Your financial data is visualized here, showing trends in income, expenses, and your net balance over time.', attachTo: { element: '#charts-grid', on: 'top' } }, { id: 'dash-5', title: 'Navigation Tabs', text: 'Use these tabs to navigate to other sections of the app, like adding new entries or managing your data.', attachTo: { element: 'nav .tab-btn', on: 'bottom' } } ];
        const addEntrySteps = [ { id: 'add-1', title: 'Add a New Entry', text: 'This form is where you record all your income and expenses.', attachTo: { element: '#entryForm', on: 'right' } }, { id: 'add-2', title: 'Fill in the Details', text: 'Enter the date, type, source, a brief description (narration), and the amount for your transaction.', attachTo: { element: '#addEntryBtn', on: 'bottom' } }, { id: 'add-3', title: 'Recent Entries', text: 'Your most recent transactions for the selected journal will appear here for a quick review.', attachTo: { element: '#recent-entries-panel', on: 'left' } } ];
        const manageEntriesSteps = [ { id: 'manage-1', title: 'Manage All Entries', text: 'This is the main table for viewing, searching, and filtering all your records.', attachTo: { element: '#manage-journal-select', on: 'bottom' } }, { id: 'manage-2', title: 'Filter and Sort', text: 'Use these powerful controls to find specific entries. You can filter by date, type, method, or search by narration.', attachTo: { element: '#manage-filters', on: 'bottom' } }, { id: 'manage-3', title: 'Download to Excel', text: 'Click here to download the currently filtered view as a formatted Excel file.', attachTo: { element: '#downloadBtn', on: 'left' } } ];
        const dataManagementSteps = [ { id: 'data-1', title: 'Manage Journals', text: 'Here you can create new journals, merge existing ones, rename, or delete them.', attachTo: { element: '#createJournalBtn', on: 'bottom' } }, { id: 'data-2', title: 'Merging Journals', text: 'The merge tool allows you to combine two journals. Note: You can only merge journals if their entries are from the same year.', attachTo: { element: '#mergeJournalBtn', on: 'bottom' } }, { id: 'data-3', title: 'Data Backup', text: 'It\'s a good practice to download a JSON backup of your data periodically. You can use this file to restore your data later.', attachTo: { element: '#downloadBackupBtn', on: 'top' } } ];
        [loginSteps, dashboardSteps, addEntrySteps, manageEntriesSteps, dataManagementSteps].forEach(stepList => { stepList.forEach((step, i) => { step.buttons = i === 0 ? buttons.first : i === stepList.length - 1 ? buttons.last : buttons.middle; }); });
        if (context === 'login') { tour.addSteps(loginSteps); } else if (context === 'app') { if (!tabContents.dashboard.classList.contains('hidden')) { tour.addSteps(dashboardSteps); } else if (!tabContents.add.classList.contains('hidden')) { tour.addSteps(addEntrySteps); } else if (!tabContents.manage.classList.contains('hidden')) { tour.addSteps(manageEntriesSteps); } else if (!tabContents.data.classList.contains('hidden')) { tour.addSteps(dataManagementSteps); } }
        tour.start();
    }
    loginHelpBtn.addEventListener('click', () => startTour('login'));
    appHelpBtn.addEventListener('click', () => startTour('app'));
    // END: HELP TOUR LOGIC
    
    // START: EXCEL DOWNLOAD SCRIPT
    downloadBtn.addEventListener('click', async () => {
        const entriesToDownload = getFilteredEntries();
        let journalName = "Journal";
        if (viewOptions.currentJournalView === 'all') {
            journalName = 'All_Journals';
        } else {
            journalName = appData.journals[viewOptions.currentJournalView]?.name || "Journal";
        }
        
        if (entriesToDownload.length === 0) {
            showToast("No entries to download in the current view.", "info");
            return;
        }

        downloadBtn.disabled = true;
        showToast('Preparing your workbook...', 'info');

        try {
            const pyodide = await loadPy();
            pyodide.globals.set('entries_json', JSON.stringify(entriesToDownload));
            pyodide.globals.set('journal_name_js', journalName);
            
            const base64Data = await pyodide.runPythonAsync(`
import json, io, base64
from datetime import datetime
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from itertools import groupby
from collections import defaultdict

header_font = Font(name='Calibri', size=11, bold=True, color='FFFFFFFF')
subheader_font = Font(name='Calibri', size=11, bold=True)
vertical_month_font = Font(name='Calibri', size=28, bold=True)
data_font = Font(name='Calibri', size=11)
year_font = Font(name='Calibri', size=18, bold=True, color='FFFFFFFF')
center_align = Alignment(horizontal='center', vertical='center', wrap_text=True)
right_align = Alignment(horizontal='right', vertical='center', wrap_text=True)
vertical_align = Alignment(text_rotation=90, vertical='center', horizontal='center')
blue_fill = PatternFill(start_color='4472C4', end_color='4472C4', fill_type='solid')
orange_fill = PatternFill(start_color='ED7D31', end_color='ED7D31', fill_type='solid')
black_fill = PatternFill(start_color='000000', end_color='000000', fill_type='solid')
gray_fill = PatternFill(start_color='808080', end_color='808080', fill_type='solid')
thin_side = Side(style='thin', color='000000')
thin_border = Border(left=thin_side, right=thin_side, top=thin_side, bottom=thin_side)
currency_format = '"UGX"* #,##0'
MIN_ROWS_PER_MONTH = 35

def create_month_table(worksheet, start_row, month_name, income_entries, expense_entries):
    worksheet.merge_cells(start_row=start_row, start_column=3, end_row=start_row, end_column=5); cell = worksheet.cell(start_row, 3); cell.value = 'INCOME'; cell.fill = blue_fill; cell.font = header_font; cell.alignment = center_align
    worksheet.merge_cells(start_row=start_row, start_column=7, end_row=start_row, end_column=9); cell = worksheet.cell(start_row, 7); cell.value = 'EXPENSES'; cell.fill = orange_fill; cell.font = header_font; cell.alignment = center_align
    
    income_headers = {'C': 'Date', 'D': 'Amount', 'E': 'Narration'}
    expense_headers = {'G': 'Date', 'H': 'Amount', 'I': 'Narration'}

    for col_char, text in income_headers.items():
        cell = worksheet[f'{col_char}{start_row+1}']; cell.value = text; cell.font = subheader_font; cell.alignment = center_align
    for col_char, text in expense_headers.items():
        cell = worksheet[f'{col_char}{start_row+1}']; cell.value = text; cell.font = subheader_font; cell.alignment = center_align

    current_income_row = start_row + 2
    for date, group in groupby(income_entries, key=lambda x: x.get('date')):
        group_list = list(group)
        num_entries = len(group_list)
        date_obj = datetime.strptime(date, '%Y-%m-%d')
        date_cell = worksheet.cell(row=current_income_row, column=3, value=date_obj); date_cell.number_format = 'DD/MM/YYYY'; date_cell.font = data_font; date_cell.alignment = center_align
        if num_entries > 1: worksheet.merge_cells(start_row=current_income_row, start_column=3, end_row=current_income_row + num_entries - 1, end_column=3)
        for i, entry in enumerate(group_list):
            row_idx = current_income_row + i
            worksheet.cell(row_idx, column=4, value=entry.get('amount')).number_format = currency_format; worksheet.cell(row_idx, column=4).font = data_font
            narration_cell = worksheet.cell(row_idx, column=5, value=entry.get('narration')); narration_cell.font = data_font; narration_cell.alignment = right_align
        current_income_row += num_entries

    current_expense_row = start_row + 2
    for date, group in groupby(expense_entries, key=lambda x: x.get('date')):
        group_list = list(group)
        num_entries = len(group_list)
        date_obj = datetime.strptime(date, '%Y-%m-%d')
        date_cell = worksheet.cell(row=current_expense_row, column=7, value=date_obj); date_cell.number_format = 'DD/MM/YYYY'; date_cell.font = data_font; date_cell.alignment = center_align
        if num_entries > 1: worksheet.merge_cells(start_row=current_expense_row, start_column=7, end_row=current_expense_row + num_entries - 1, end_column=7)
        for i, entry in enumerate(group_list):
            row_idx = current_expense_row + i
            worksheet.cell(row_idx, column=8, value=entry.get('amount')).number_format = currency_format; worksheet.cell(row_idx, column=8).font = data_font
            narration_cell = worksheet.cell(row_idx, column=9, value=entry.get('narration')); narration_cell.font = data_font; narration_cell.alignment = right_align
        current_expense_row += num_entries
        
    table_end_row = max(current_income_row, current_expense_row, start_row + MIN_ROWS_PER_MONTH)
    for r in range(start_row, table_end_row):
        worksheet[f'F{r}'].fill = black_fill
    for r in range(start_row, table_end_row):
      for c_ord in list(range(ord('C'), ord('F'))) + list(range(ord('G'), ord('J'))):
            worksheet.cell(row=r, column=c_ord - ord('A') + 1).border = thin_border
            
    data_start_row = start_row + 2
    if data_start_row < table_end_row:
        worksheet.merge_cells(start_row=data_start_row, start_column=1, end_row=table_end_row - 1, end_column=1)
        cell = worksheet.cell(row=data_start_row, column=1); cell.value = month_name.upper(); cell.font = vertical_month_font; cell.alignment = vertical_align
        
    return table_end_row

wb = Workbook()
ws_mtn = wb.create_sheet("MTN")
ws_airtel = wb.create_sheet("Airtel")
ws_bank = wb.create_sheet("Bank")
if 'Sheet' in wb.sheetnames:
    wb.remove(wb['Sheet'])

entries = sorted([e for e in json.loads(entries_json) if e.get('date')], key=lambda x: x['date'])
data_by_method = {
    "MTN": (ws_mtn, [e for e in entries if e.get('method') == 'MTN']),
    "Airtel": (ws_airtel, [e for e in entries if e.get('method') == 'Airtel']),
    "Bank": (ws_bank, [e for e in entries if e.get('method') == 'Bank'])
}

column_widths = {'A': 5, 'B': 1, 'C': 12, 'D': 15, 'E': 30, 'F': 1.5, 'G': 12, 'H': 15, 'I': 30}
for method, (worksheet, method_entries) in data_by_method.items():
    for col, width in column_widths.items():
        worksheet.column_dimensions[col].width = width
        
    yearly_data = defaultdict(lambda: defaultdict(lambda: {'income': [], 'expense': []}))
    for entry in method_entries:
        dt = datetime.strptime(entry['date'], '%Y-%m-%d')
        year_key = dt.strftime('%Y')
        month_key = dt.strftime('%m')
        if entry['type'] == 'Income':
            yearly_data[year_key][month_key]['income'].append(entry)
        else:
            yearly_data[year_key][month_key]['expense'].append(entry)
    
    current_row = 2
    if not yearly_data:
        create_month_table(worksheet, current_row, "No Data", [], [])
    else:
        for year_key in sorted(yearly_data.keys()):
            worksheet.merge_cells(start_row=current_row, start_column=1, end_row=current_row, end_column=9)
            year_cell = worksheet.cell(row=current_row, column=1)
            year_cell.value = int(year_key)
            year_cell.font = year_font
            year_cell.fill = gray_fill
            year_cell.alignment = center_align
            current_row += 2
            
            monthly_data = yearly_data[year_key]
            for month_key in sorted(monthly_data.keys()):
                month_name = datetime(int(year_key), int(month_key), 1).strftime('%B')
                data = monthly_data[month_key]
                current_row = create_month_table(worksheet, current_row, month_name, data['income'], data['expense']) + 3

bio = io.BytesIO(); wb.save(bio)
base64.b64encode(bio.getvalue()).decode('utf-8')
`);
            showToast('Download starting...', 'success');
            const blob = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
            const url = URL.createObjectURL(new Blob([blob], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
            const a = document.createElement('a');
            a.href = url;
            a.download = `${journalName.replace(/ /g, '_')}_Journal.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (err) {
            console.error('Error generating file:', err.message);
            showToast('Error! Could not generate file.', 'error');
        } finally {
            downloadBtn.disabled = getFilteredEntries().length === 0;
            statusMessage.textContent = '';
        }
    });

    // Initial theme setup on script load
    applyTheme();

  </script>
</body>
</html>
